<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trading Platform{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">AUTO OPTIMIZE TRADING SYSTEM</a>
        <ul class="navbar-nav">
            <li><a href="/manual-trading" class="nav-link {% if active_page == 'manual' %}active{% endif %}">Manual Trading</a></li>
            <li><a href="/bot-trading" class="nav-link {% if active_page == 'bot' %}active{% endif %}">Bot Trading</a></li>
            <li><a href="/strategy" class="nav-link {% if active_page == 'strategy' %}active{% endif %}">Strategy</a></li>
            <li><a href="/backtest" class="nav-link {% if active_page == 'backtest' %}active{% endif %}">Backtest</a></li>
            <li><a href="/optimize" class="nav-link {% if active_page == 'optimize' %}active{% endif %}">Optimize</a></li>
            <li><a href="/hft" class="nav-link {% if active_page == 'hft' %}active{% endif %}">HFT</a></li>
            <li><a href="/exchange" class="nav-link {% if active_page == 'exchange' %}active{% endif %}">Exchange</a></li>
            <li><a href="/clients" class="nav-link {% if active_page == 'clients' %}active{% endif %}">Clients</a></li>
        </ul>
        <div class="navbar-actions">
            <button id="upload-data-btn" class="btn btn-primary">üì§ Upload Data</button>
            <button class="btn btn-secondary">‚öôÔ∏è</button>
            <button class="btn btn-danger">TEST</button>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- Upload Data Tooltip -->
    <div id="upload-tooltip" style="display: none; position: fixed; z-index: 1000; background: #1a1f2e; border: 1px solid #2d3748; border-radius: 8px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 300px;">
        <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1rem;">üìÅ Th√¥ng tin d·ªØ li·ªáu:</h3>
        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Tr·∫°ng th√°i:</span>
                <span style="color: #10b981; display: flex; align-items: center; gap: 0.25rem;">
                    <input type="checkbox" id="data-status" checked disabled style="margin: 0;">
                    <span>ƒê√£ l∆∞u</span>
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">T√™n file:</span>
                <span style="color: var(--text-primary);" id="data-filename">VN30F1M_31 10 25_14 45 00 Python...</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Timeframe:</span>
                <span style="color: #3b82f6; font-weight: 600;" id="data-timeframe">1M</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">T·ª´ ng√†y:</span>
                <span style="color: var(--text-primary);" id="data-from">02 09:35/01/2025</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">ƒê·∫øn ng√†y:</span>
                <span style="color: var(--text-primary);" id="data-to">31 14:45/10/2025</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">S·ªë n·∫øn:</span>
                <span style="color: var(--text-primary);" id="data-bars">49,641</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Dung l∆∞·ª£ng:</span>
                <span style="color: var(--text-primary);" id="data-size">4.17 MB</span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button id="upload-btn" class="btn btn-primary" style="flex: 1; padding: 0.5rem;">üìÅ Upload</button>
            <button id="delete-data-btn" class="btn btn-danger" style="flex: 1; padding: 0.5rem;">üóëÔ∏è X√≥a</button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1f2e; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; border: 1px solid #2d3748;">
            <h2 style="margin: 0 0 1.5rem 0; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem;">
                üìä C·∫•u h√¨nh d·ªØ li·ªáu
            </h2>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Timeframe c·ªßa d·ªØ li·ªáu:</label>
                <select id="timeframe-select" class="form-control" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                    <option value="1m" selected>1 ph√∫t (1m)</option>
                    <option value="5m">5 ph√∫t (5m)</option>
                    <option value="15m">15 ph√∫t (15m)</option>
                    <option value="30m">30 ph√∫t (30m)</option>
                    <option value="1h">1 gi·ªù (1h)</option>
                    <option value="4h">4 gi·ªù (4h)</option>
                    <option value="1d">1 ng√†y (1D)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">M√∫i gi·ªù c·ªßa file CSV:</label>
                <select id="csv-utc-select" class="form-control" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                    <option value="0">UTC +0 (London)</option>
                    <option value="1">UTC +1 (Paris)</option>
                    <option value="2">UTC +2 (Cairo)</option>
                    <option value="3">UTC +3 (Moscow)</option>
                    <option value="4">UTC +4 (Dubai)</option>
                    <option value="5">UTC +5 (Karachi)</option>
                    <option value="6">UTC +6 (Dhaka)</option>
                    <option value="7" selected>UTC +7 (Vietnam, Bangkok)</option>
                    <option value="8">UTC +8 (Singapore, HK)</option>
                    <option value="9">UTC +9 (Tokyo)</option>
                    <option value="10">UTC +10 (Sydney)</option>
                    <option value="-5">UTC -5 (New York)</option>
                    <option value="-6">UTC -6 (Chicago)</option>
                    <option value="-7">UTC -7 (Denver)</option>
                    <option value="-8">UTC -8 (Los Angeles)</option>
                </select>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; font-size: 0.75rem; color: var(--text-secondary);">
                    üí° Ch·ªçn m√∫i gi·ªù c·ªßa d·ªØ li·ªáu trong file CSV. Chart s·∫Ω t·ª± ƒë·ªông convert v·ªÅ m√∫i gi·ªù hi·ªán t·∫°i.
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button id="modal-cancel-btn" class="btn btn-secondary" style="flex: 1; padding: 0.75rem;">H·ªßy</button>
                <button id="modal-confirm-btn" class="btn btn-primary" style="flex: 1; padding: 0.75rem;">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Common Scripts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/connection-manager.js') }}"></script>
    
    <!-- Upload Data Handler -->
    <script>
    // Global upload data manager
    window.UploadDataManager = {
        currentFile: null,
        csvData: null,
        fileInfo: null,
        
        init() {
            this.setupUploadButton();
            this.loadStoredData();
        },
        
        setupUploadButton() {
            const uploadBtn = document.getElementById('upload-data-btn');
            const tooltip = document.getElementById('upload-tooltip');
            const uploadModal = document.getElementById('upload-modal');
            const uploadBtnInTooltip = document.getElementById('upload-btn');
            const deleteBtn = document.getElementById('delete-data-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            // Toggle tooltip
            uploadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const rect = uploadBtn.getBoundingClientRect();
                tooltip.style.display = tooltip.style.display === 'none' ? 'block' : 'none';
                tooltip.style.top = rect.bottom + 10 + 'px';
                tooltip.style.right = (window.innerWidth - rect.right) + 'px';
            });
            
            // Close tooltip when clicking outside
            document.addEventListener('click', (e) => {
                if (!tooltip.contains(e.target) && e.target !== uploadBtn) {
                    tooltip.style.display = 'none';
                }
            });
            
            // Upload button in tooltip
            uploadBtnInTooltip.addEventListener('click', () => {
                tooltip.style.display = 'none';
                this.openFileDialog();
            });
            
            // Delete button
            deleteBtn.addEventListener('click', () => {
                if (confirm('X√≥a d·ªØ li·ªáu ƒë√£ upload?')) {
                    this.clearData();
                    tooltip.style.display = 'none';
                }
            });
            
            // Modal buttons
            modalCancelBtn.addEventListener('click', () => {
                uploadModal.style.display = 'none';
                this.currentFile = null;
            });
            
            modalConfirmBtn.addEventListener('click', () => {
                const timeframe = document.getElementById('timeframe-select').value;
                const csvUtc = parseInt(document.getElementById('csv-utc-select').value);
                this.processFile(timeframe, csvUtc);
                uploadModal.style.display = 'none';
            });
        },
        
        openFileDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                this.currentFile = e.target.files[0];
                if (this.currentFile) {
                    // Show modal to select timeframe
                    document.getElementById('upload-modal').style.display = 'flex';
                }
            };
            input.click();
        },
        
        async processFile(timeframe, csvUtc) {
            if (!this.currentFile) return;
            
            console.log('Processing file with timeframe:', timeframe, 'and UTC:', csvUtc);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                this.csvData = this.parseCSV(text);
                
                if (this.csvData.length === 0) {
                    alert('File CSV kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng');
                    return;
                }
                
                // Calculate file info
                const firstBar = this.csvData[0];
                const lastBar = this.csvData[this.csvData.length - 1];
                const fileSize = (this.currentFile.size / (1024 * 1024)).toFixed(2);
                
                this.fileInfo = {
                    filename: this.currentFile.name,
                    timeframe: timeframe,
                    csvUtc: csvUtc, // UTC offset of CSV data
                    fromDate: `${firstBar.date} ${firstBar.time}`,
                    toDate: `${lastBar.date} ${lastBar.time}`,
                    bars: this.csvData.length.toLocaleString(),
                    size: `${fileSize} MB`,
                    ticker: firstBar.ticker
                };
                
                // Update tooltip
                this.updateTooltip();
                
                // Save to localStorage
                this.saveData();
                
                // Load data to chart if on chart page
                this.loadToChart();
                
                alert(`‚úÖ Upload th√†nh c√¥ng!\n\nFile: ${this.fileInfo.filename}\nTimeframe: ${timeframe}\nS·ªë n·∫øn: ${this.fileInfo.bars}`);
            };
            
            reader.readAsText(this.currentFile);
        },
        
        parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            const data = [];
            
            console.log('Parsing CSV with', lines.length, 'lines');
            
            // Skip header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Remove any \r characters
                const cleanLine = line.replace(/\r/g, '');
                const parts = cleanLine.split(',');
                
                if (parts.length < 8) continue;
                
                // Parse: Ticker,Date,Time,Open,High,Low,Close,Volume
                const bar = {
                    ticker: parts[0].trim(),
                    date: parts[1].trim(),
                    time: parts[2].trim(),
                    open: parseFloat(parts[3]),
                    high: parseFloat(parts[4]),
                    low: parseFloat(parts[5]),
                    close: parseFloat(parts[6]),
                    volume: parseInt(parts[7])
                };
                
                // Validate
                if (!isNaN(bar.open) && !isNaN(bar.close)) {
                    data.push(bar);
                }
            }
            
            console.log('Parsed', data.length, 'valid bars');
            if (data.length > 0) {
                console.log('First bar:', data[0]);
                console.log('Last bar:', data[data.length - 1]);
            }
            
            return data;
        },
        
        updateTooltip() {
            if (!this.fileInfo) return;
            
            document.getElementById('data-status').checked = true;
            document.getElementById('data-filename').textContent = this.fileInfo.filename.substring(0, 30) + '...';
            document.getElementById('data-timeframe').textContent = this.fileInfo.timeframe.toUpperCase();
            document.getElementById('data-from').textContent = this.fileInfo.fromDate;
            document.getElementById('data-to').textContent = this.fileInfo.toDate;
            document.getElementById('data-bars').textContent = this.fileInfo.bars;
            document.getElementById('data-size').textContent = this.fileInfo.size;
        },
        
        saveData() {
            localStorage.setItem('uploadedCSVData', JSON.stringify(this.csvData));
            localStorage.setItem('uploadedFileInfo', JSON.stringify(this.fileInfo));
        },
        
        loadStoredData() {
            const storedData = localStorage.getItem('uploadedCSVData');
            const storedInfo = localStorage.getItem('uploadedFileInfo');
            
            if (storedData && storedInfo) {
                console.log('üì¶ Restoring data from localStorage...');
                this.csvData = JSON.parse(storedData);
                this.fileInfo = JSON.parse(storedInfo);
                console.log('‚úÖ Restored:', this.csvData.length, 'bars');
                this.updateTooltip();
                
                // IMPORTANT: Load data to chart after restore
                setTimeout(() => {
                    console.log('üîÑ Loading restored data to charts...');
                    if (window.chartManual) {
                        window.chartManual.loadChartData();
                    }
                    if (window.chartBot) {
                        window.chartBot.loadChartData();
                    }
                    if (window.chartStrategy) {
                        window.chartStrategy.loadChartData();
                    }
                }, 1000);
            } else {
                console.log('‚ÑπÔ∏è No stored data found');
            }
        },
        
        clearData() {
            this.csvData = null;
            this.fileInfo = null;
            this.currentFile = null;
            localStorage.removeItem('uploadedCSVData');
            localStorage.removeItem('uploadedFileInfo');
            
            // Reset tooltip to default
            document.getElementById('data-status').checked = false;
            document.getElementById('data-filename').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
            document.getElementById('data-timeframe').textContent = '-';
            document.getElementById('data-from').textContent = '-';
            document.getElementById('data-to').textContent = '-';
            document.getElementById('data-bars').textContent = '0';
            document.getElementById('data-size').textContent = '0 MB';
            
            // Clear chart if present
            if (window.chartManual) window.chartManual.clearChart();
            if (window.chartBot) window.chartBot.clearChart();
            if (window.chartStrategy) window.chartStrategy.clearChart();
        },
        
        loadToChart() {
            console.log('üîµ loadToChart() called');
            
            if (!this.csvData || this.csvData.length === 0) {
                console.warn('‚ö†Ô∏è No CSV data to load');
                return;
            }
            
            try {
                console.log('üìä Loading', this.csvData.length, 'bars to chart');
                console.log('First CSV bar:', this.csvData[0]);
                console.log('Last CSV bar:', this.csvData[this.csvData.length - 1]);
                
                // Convert CSV data to chart format
                const chartData = [];
                const volumeData = [];
                
                for (let i = 0; i < this.csvData.length; i++) {
                    const bar = this.csvData[i];
                    
                    // Get CSV UTC offset from fileInfo (default to +7 if not set)
                    const csvUtcOffset = this.fileInfo && this.fileInfo.csvUtc !== undefined ? this.fileInfo.csvUtc : 7;
                    
                    // Parse date components
                    const dateParts = bar.date.split('-'); // YYYY-MM-DD
                    const timeParts = bar.time.split(':'); // HH:MM:SS
                    
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // JS months are 0-indexed
                    const day = parseInt(dateParts[2]);
                    const hour = parseInt(timeParts[0]);
                    const minute = parseInt(timeParts[1]);
                    const second = parseInt(timeParts[2] || 0);
                    
                    // Create UTC timestamp
                    // CSV time is in csvUtcOffset timezone
                    // Convert to UTC by subtracting the offset
                    const csvTimestamp = Date.UTC(year, month, day, hour, minute, second);
                    const utcTimestamp = csvTimestamp - (csvUtcOffset * 3600 * 1000);
                    const timestamp = Math.floor(utcTimestamp / 1000);
                    
                    // Debug first and every 10000th bar
                    if (i === 0 || i === 10000 || i === 20000 || i === 30000 || i === 40000) {
                        console.log(`Bar ${i} conversion:`, {
                            csvDate: bar.date,
                            csvTime: bar.time,
                            timestamp: timestamp,
                            utcDate: new Date(utcTimestamp).toISOString()
                        });
                    }
                    
                    chartData.push({
                        time: timestamp,
                        open: bar.open,
                        high: bar.high,
                        low: bar.low,
                        close: bar.close,
                        date: bar.date,
                        timeStr: bar.time
                    });
                    
                    volumeData.push({
                        time: timestamp,
                        value: bar.volume,
                        color: bar.close >= bar.open ? '#10b98180' : '#ef444480'
                    });
                }
            
            console.log('‚úÖ Converted to', chartData.length, 'chart bars');
            console.log('First chart bar:', chartData[0]);
            console.log('Last chart bar:', chartData[chartData.length - 1]);
            console.log('Time range:', new Date(chartData[0].time * 1000), 'to', new Date(chartData[chartData.length - 1].time * 1000));
            
            // Store metadata
            this.chartMetadata = {
                firstBar: this.csvData[0],
                lastBar: this.csvData[this.csvData.length - 1],
                totalBars: chartData.length
            };
            
            console.log('üì§ Calling chart.loadUploadedData()...');
            console.log('  chartData.length:', chartData.length);
            console.log('  volumeData.length:', volumeData.length);
            
            // Load to active chart
            if (window.chartManual && typeof window.chartManual.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartManual');
                window.chartManual.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartManual load completed');
            } else {
                console.warn('‚ö†Ô∏è chartManual not available');
            }
            
            if (window.chartBot && typeof window.chartBot.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartBot');
                window.chartBot.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartBot load completed');
            } else {
                console.warn('‚ö†Ô∏è chartBot not available');
            }
            
            if (window.chartStrategy && typeof window.chartStrategy.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartStrategy');
                window.chartStrategy.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartStrategy load completed');
            } else {
                console.warn('‚ö†Ô∏è chartStrategy not available');
            }
            
            console.log('üéâ loadToChart() completed successfully');
            
            } catch (error) {
                console.error('‚ùå Error in loadToChart():', error);
                console.error('Stack:', error.stack);
                alert('L·ªói khi load data l√™n chart: ' + error.message);
            }
        },
        
        getData() {
            return {
                csvData: this.csvData,
                fileInfo: this.fileInfo
            };
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        window.UploadDataManager.init();
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
