<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Reports - Auto Optimize</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/workspace.css') }}">
    <style>
        body {
            background: #131722;
            color: #d1d4dc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .reports-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .client-header {
            background: #1e222d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .client-meta {
            font-size: 13px;
            color: #787b86;
        }

        .btn-back {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1e222d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #787b86;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        .stat-value.positive {
            color: #4caf50;
        }

        .stat-value.negative {
            color: #ef5350;
        }

        .trades-section {
            background: #1e222d;
            border-radius: 8px;
            padding: 20px;
        }

        .section-header {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #787b86;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #2962ff;
            color: white;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table thead {
            background: rgba(255, 255, 255, 0.03);
        }

        .trades-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #787b86;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trades-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: #ffffff;
        }

        .trades-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .trade-side {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .trade-side.long {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .trade-side.short {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }

        .pnl-value {
            font-weight: 600;
        }

        .pnl-value.positive {
            color: #4caf50;
        }

        .pnl-value.negative {
            color: #ef5350;
        }

        .empty-trades {
            text-align: center;
            padding: 40px;
            color: #787b86;
        }

        .chart-container {
            background: #1e222d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% include 'header_common.html' %}
    
    <div class="reports-container">
        <div class="client-header">
            <div class="client-info">
                <div class="client-name" id="clientName">Loading...</div>
                <div class="client-meta" id="clientMeta"></div>
            </div>
            <button class="btn-back" onclick="window.location.href='/client-management'">
                ‚Üê Back to Clients
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Trades</div>
                <div class="stat-value" id="totalTrades">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value" id="winRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total PnL</div>
                <div class="stat-value" id="totalPnL">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Win</div>
                <div class="stat-value positive" id="avgWin">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Loss</div>
                <div class="stat-value negative" id="avgLoss">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Profit Factor</div>
                <div class="stat-value" id="profitFactor">0</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="pnlChart"></canvas>
        </div>

        <div class="trades-section">
            <div class="section-header">
                <span>üìä Trade History</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="filterTrades('all')">All</button>
                    <button class="filter-btn" data-filter="winning" onclick="filterTrades('winning')">Winning</button>
                    <button class="filter-btn" data-filter="losing" onclick="filterTrades('losing')">Losing</button>
                </div>
            </div>

            <div id="tradesTableContainer">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry Price</th>
                            <th>Exit Price</th>
                            <th>Volume</th>
                            <th>PnL</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <tr>
                            <td colspan="8" class="empty-trades">
                                No trades yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const clientId = '{{ client_id }}';
        let allTrades = [];
        let currentFilter = 'all';
        let pnlChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadClientData();
            setActiveTab('client-management');
        });

        function setActiveTab(page) {
            document.querySelectorAll('.header-tab').forEach(tab => {
                tab.classList.remove('active');
            });
        }

        async function loadClientData() {
            try {
                // Load client info
                const clientResponse = await fetch(`/api/clients/${clientId}`);
                if (clientResponse.ok) {
                    const client = await clientResponse.json();
                    document.getElementById('clientName').textContent = client.name;
                    document.getElementById('clientMeta').textContent = 
                        `${client.email || ''} ${client.phone ? '‚Ä¢ ' + client.phone : ''}`;
                }

                // Load trades
                const tradesResponse = await fetch(`/api/clients/${clientId}/trades`);
                if (tradesResponse.ok) {
                    const data = await tradesResponse.json();
                    allTrades = data.trades || [];
                    updateStats(data.summary);
                    renderTrades();
                    renderChart();
                }
            } catch (error) {
                console.error('Error loading client data:', error);
            }
        }

        function updateStats(summary) {
            document.getElementById('totalTrades').textContent = summary.total_trades || 0;
            document.getElementById('winRate').textContent = (summary.win_rate || 0).toFixed(1) + '%';
            
            const totalPnL = summary.total_pnl || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = (totalPnL >= 0 ? '+' : '') + totalPnL.toLocaleString() + ' VND';
            pnlElement.className = 'stat-value ' + (totalPnL >= 0 ? 'positive' : 'negative');
            
            document.getElementById('avgWin').textContent = '+' + (summary.average_win || 0).toLocaleString();
            document.getElementById('avgLoss').textContent = (summary.average_loss || 0).toLocaleString();
            document.getElementById('profitFactor').textContent = (summary.profit_factor || 0).toFixed(2);
        }

        function renderTrades() {
            const tbody = document.getElementById('tradesTableBody');
            
            let filteredTrades = allTrades;
            if (currentFilter === 'winning') {
                filteredTrades = allTrades.filter(t => t.pnl > 0);
            } else if (currentFilter === 'losing') {
                filteredTrades = allTrades.filter(t => t.pnl <= 0);
            }
            
            if (filteredTrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-trades">
                            No ${currentFilter !== 'all' ? currentFilter + ' ' : ''}trades found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredTrades.map(trade => `
                <tr>
                    <td>${new Date(trade.date).toLocaleString()}</td>
                    <td>${trade.symbol}</td>
                    <td><span class="trade-side ${trade.side.toLowerCase()}">${trade.side}</span></td>
                    <td>${trade.entry_price.toFixed(2)}</td>
                    <td>${trade.exit_price.toFixed(2)}</td>
                    <td>${trade.volume}</td>
                    <td class="pnl-value ${trade.pnl >= 0 ? 'positive' : 'negative'}">
                        ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toLocaleString()} VND
                    </td>
                    <td>${trade.duration}</td>
                </tr>
            `).join('');
        }

        function filterTrades(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            renderTrades();
        }

        function renderChart() {
            const ctx = document.getElementById('pnlChart');
            
            if (pnlChart) {
                pnlChart.destroy();
            }
            
            // Calculate cumulative PnL
            let cumulativePnL = 0;
            const chartData = allTrades.map(trade => {
                cumulativePnL += trade.pnl;
                return {
                    x: new Date(trade.date),
                    y: cumulativePnL
                };
            });
            
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cumulative PnL',
                        data: chartData,
                        borderColor: '#2962ff',
                        backgroundColor: 'rgba(41, 98, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Cumulative PnL Over Time',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            ticks: {
                                color: '#787b86'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#787b86',
                                callback: function(value) {
                                    return value.toLocaleString() + ' VND';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
