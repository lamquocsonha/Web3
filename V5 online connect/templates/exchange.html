{% extends "base.html" %}

{% block title %}Exchange{% endblock %}

{% set active_page = 'exchange' %}

{% block content %}
<div style="display: flex; height: calc(100vh - 60px);">
    <!-- Left Sidebar: Saved Profiles -->
    <div style="flex: 0 0 320px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); overflow-y: auto;">
        <div class="sidebar-header">
            <h3 class="sidebar-title">üìÅ Saved Profiles</h3>
        </div>

        <div style="padding: 1rem;">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All</button>
                <button class="filter-tab" data-filter="data">üìä Data</button>
                <button class="filter-tab" data-filter="trading">üíπ Trading</button>
            </div>

            <div id="profiles-container" style="margin-top: 1rem;">
                <!-- Profiles will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Center: Add New Profile Form -->
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
        <div class="add-profile-section">
            <h2 style="margin-bottom: 1.5rem;">‚ûï Add New Profile</h2>

            <div class="card" style="max-width: 800px;">
                <div class="card-header">
                    <h3 class="card-title">BASIC INFORMATION</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Profile Name</label>
                        <input type="text" id="profile-name" class="form-control" placeholder="e.g. Binance Main, MT5 Demo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Exchange</label>
                        <select id="exchange-select" class="form-control">
                            <option value="">-- Select Exchange --</option>
                            <option value="DNSE">DNSE</option>
                            <option value="ENTRADE">Entrade</option>
                            <option value="ENTRADE-MQTT">Entrade MQTT</option>
                            <option value="MT5">MetaTrader 5</option>
                            <option value="BINANCE">Binance</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- DNSE Credentials Card -->
            <div class="card" id="dnse-credentials-card" style="max-width: 800px; margin-top: 1.5rem; display: none;">
                <div class="card-header">
                    <h3 class="card-title">DNSE CREDENTIALS (C√ì PHI·∫æU + PH√ÅI SINH)</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Protocol</label>
                        <select id="dnse-protocol" class="form-control">
                            <option value="rest">REST API (Trading + Email OTP)</option>
                            <option value="mqtt">MQTT (Real-time Market Data)</option>
                            <option value="public">Public API (Historical Data - No Credentials)</option>
                        </select>
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            REST API cho ƒë·∫∑t l·ªánh, MQTT cho realtime, Public cho historical data (kh√¥ng c·∫ßn credentials)
                        </p>
                    </div>

                    <div class="form-group" id="dnse-username-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="dnse-username" class="form-control" placeholder="0919990540">
                    </div>

                    <div class="form-group" id="dnse-password-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="dnse-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <div class="form-group" id="dnse-otp-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="dnse-require-otp" checked>
                            <span>üîê Y√™u c·∫ßu x√°c th·ª±c OTP khi k·∫øt n·ªëi (Email OTP)</span>
                        </label>
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            N·∫øu b·∫≠t, s·∫Ω hi·ªÉn th·ªã modal nh·∫≠p OTP khi b·∫•m "Test Connection"
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tickers (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
                        <input type="text" id="dnse-tickers" class="form-control" placeholder="VD: VN30F1M,VNM,FPT,VCB" value="VD: VN30F1M,VNM,FPT,VCB">
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            Danh s√°ch ticker s·∫Ω hi·ªÉn th·ªã khi ch·ªçn profile
                        </p>
                    </div>
                </div>
            </div>

            <!-- Market Data Settings Card -->
            <div class="card" id="market-data-settings-card" style="max-width: 800px; margin-top: 1.5rem; display: none;">
                <div class="card-header">
                    <h3 class="card-title">üìä MARKET DATA SETTINGS</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Timeframe m·∫∑c ƒë·ªãnh</label>
                        <select id="default-timeframe" class="form-control">
                            <option value="1m" selected>1 Minute (M1)</option>
                            <option value="5m">5 Minutes (M5)</option>
                            <option value="15m">15 Minutes (M15)</option>
                            <option value="30m">30 Minutes (M30)</option>
                            <option value="1h">1 Hour (H1)</option>
                            <option value="4h">4 Hours (H4)</option>
                            <option value="1d">1 Day (D1)</option>
                        </select>
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            Timeframe s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ch·ªçn khi k·∫øt n·ªëi
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">S·ªë n·∫øn hi·ªÉn th·ªã</label>
                        <input type="number" id="candle-count" class="form-control" placeholder="1000" value="1000" min="100" max="10000">
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            S·ªë l∆∞·ª£ng n·∫øn t·ªëi ƒëa s·∫Ω hi·ªÉn th·ªã tr√™n chart
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Timezone (GMT Offset)</label>
                        <select id="timezone-offset" class="form-control">
                            <option value="-12">GMT-12</option>
                            <option value="-11">GMT-11</option>
                            <option value="-10">GMT-10</option>
                            <option value="-9">GMT-9</option>
                            <option value="-8">GMT-8</option>
                            <option value="-7">GMT-7</option>
                            <option value="-6">GMT-6</option>
                            <option value="-5">GMT-5 (New York)</option>
                            <option value="-4">GMT-4</option>
                            <option value="-3">GMT-3</option>
                            <option value="-2">GMT-2</option>
                            <option value="-1">GMT-1</option>
                            <option value="0">GMT+0 (London)</option>
                            <option value="1">GMT+1</option>
                            <option value="2">GMT+2</option>
                            <option value="3">GMT+3 (Moscow)</option>
                            <option value="4">GMT+4</option>
                            <option value="5">GMT+5</option>
                            <option value="6">GMT+6</option>
                            <option value="7" selected>GMT+7 (Vietnam, Thailand)</option>
                            <option value="8">GMT+8 (Singapore, Hong Kong)</option>
                            <option value="9">GMT+9 (Tokyo)</option>
                            <option value="10">GMT+10 (Sydney)</option>
                            <option value="11">GMT+11</option>
                            <option value="12">GMT+12</option>
                        </select>
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                            ƒêi·ªÅu ch·ªânh m√∫i gi·ªù hi·ªÉn th·ªã tr√™n chart (GMT+7 cho Vi·ªát Nam)
                        </p>
                    </div>
                </div>
            </div>

            <div class="card" style="max-width: 800px; margin-top: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title">üéØ PROFILE USAGE</h3>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">Ch·ªçn m·ª•c ƒë√≠ch s·ª≠ d·ª•ng profile n√†y trong Connection modal</p>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 2rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="use-for-data">
                            <span>üìä Use for Market Data</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="use-for-trading">
                            <span>üíπ Use for Trading</span>
                        </label>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                        Profile n√†y s·∫Ω hi·ªán trong dropdown "Data Profile" ƒë·ªÉ load chart
                    </p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #f59e0b;">
                        (C·∫ßn Trading Token cho DNSE)
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; max-width: 800px;">
                <button id="test-connection-btn" class="btn btn-secondary">üîå Test Connection</button>
                <button id="save-profile-btn" class="btn btn-primary" style="flex: 1;">üíæ Update Profile</button>
            </div>
        </div>
    </div>

    <!-- Right Sidebar: Terminal -->
    <div style="flex: 0 0 400px; background-color: #000000; border-left: 1px solid var(--border-color); display: flex; flex-direction: column;">
        <div style="padding: 1rem;">
            <h3 style="color: #00ff00; margin-bottom: 1rem; font-family: 'Courier New', monospace;">üíª Connection Terminal</h3>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-sm btn-secondary terminal-clear">Clear</button>
                <button class="btn btn-sm btn-primary">Export</button>
            </div>
        </div>
        <div class="terminal" style="flex: 1; overflow-y: auto;">
            <div class="terminal-line terminal-output">[system] Terminal ready. Waiting for connection events...</div>
        </div>
    </div>
</div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h5><i class="fas fa-edit"></i> <span id="modalTitle">Editing profile: DNSE</span></h5>
                <button class="close-btn" onclick="Exchange.closeEditModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: calc(90vh - 200px); overflow-y: auto;">
                <!-- BASIC INFORMATION -->
                <div class="form-section">
                    <h6 class="section-title">BASIC INFORMATION</h6>

                    <div class="form-group">
                        <label class="form-label">Profile Name</label>
                        <input type="text" id="edit-profile-name" class="form-control" placeholder="DNSE">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Exchange</label>
                        <select id="edit-exchange" class="form-control">
                            <option value="DNSE">DNSE</option>
                            <option value="ENTRADE">Entrade</option>
                            <option value="ENTRADE-MQTT">Entrade MQTT</option>
                            <option value="MT5">MetaTrader 5</option>
                            <option value="BINANCE">Binance</option>
                        </select>
                    </div>
                </div>

                <!-- DNSE CREDENTIALS -->
                <div class="form-section" id="dnseCredentials">
                    <h6 class="section-title">DNSE CREDENTIALS (C√ì PHI·∫æU + PH√ÅI SINH)</h6>

                    <div class="form-group">
                        <label class="form-label">Protocol</label>
                        <select id="edit-protocol" class="form-control">
                            <option value="rest-api">REST API (Trading + Email OTP)</option>
                            <option value="websocket">WebSocket</option>
                            <option value="mqtt">MQTT</option>
                        </select>
                        <small class="form-text">REST API cho t·∫•t l·ªánh, MQTT cho realtime, Public cho historical data (kh√¥ng c·∫ßn credentials)</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="edit-username" class="form-control" placeholder="0919990840">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="edit-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="edit-otp-required" checked>
                            <span>üîí Y√™u c·∫ßu x√°c th·ª±c OTP khi k·∫øt n·ªëi (Email OTP)</span>
                        </label>
                        <small class="form-text">N·∫øu b·∫≠t, s·∫Ω hi·ªán modal nh·∫≠p OTP khi b·∫•m "Test Connection"</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tickers (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
                        <input type="text" id="edit-tickers" class="form-control" placeholder="VD: VN30F1M,VNM,FPT,VCB">
                        <small class="form-text">Danh s√°ch ticker s·∫Ω hi·ªÉn th·ªã khi ch·ªçn profile</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Timeframe m·∫∑c ƒë·ªãnh</label>
                        <select id="edit-timeframe" class="form-control">
                            <option value="1m" selected>1 Minute (M1)</option>
                            <option value="5m">5 Minutes (M5)</option>
                            <option value="15m">15 Minutes (M15)</option>
                            <option value="30m">30 Minutes (M30)</option>
                            <option value="1h">1 Hour (H1)</option>
                            <option value="4h">4 Hours (H4)</option>
                            <option value="1d">1 Day (D1)</option>
                        </select>
                        <small class="form-text">Timeframe s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ch·ªçn khi k·∫øt n·ªëi</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">S·ªë n·∫øn hi·ªÉn th·ªã</label>
                        <input type="number" id="edit-candle-count" class="form-control" value="1000" min="100" max="10000">
                        <small class="form-text">S·ªë l∆∞·ª£ng n·∫øn t·ªëi ƒëa ƒë∆∞·ª£c ch·ªçn khi k·∫øt n·ªëi</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Timezone (GMT Offset)</label>
                        <select id="edit-timezone" class="form-control">
                            <option value="-12">GMT-12</option>
                            <option value="-11">GMT-11</option>
                            <option value="-10">GMT-10</option>
                            <option value="-9">GMT-9</option>
                            <option value="-8">GMT-8</option>
                            <option value="-7">GMT-7</option>
                            <option value="-6">GMT-6</option>
                            <option value="-5">GMT-5</option>
                            <option value="-4">GMT-4</option>
                            <option value="-3">GMT-3</option>
                            <option value="-2">GMT-2</option>
                            <option value="-1">GMT-1</option>
                            <option value="0">GMT+0</option>
                            <option value="1">GMT+1</option>
                            <option value="2">GMT+2</option>
                            <option value="3">GMT+3</option>
                            <option value="4">GMT+4</option>
                            <option value="5">GMT+5</option>
                            <option value="6">GMT+6</option>
                            <option value="7" selected>GMT+7 (Vietnam, Thailand)</option>
                            <option value="8">GMT+8</option>
                            <option value="9">GMT+9</option>
                            <option value="10">GMT+10</option>
                            <option value="11">GMT+11</option>
                            <option value="12">GMT+12</option>
                        </select>
                        <small class="form-text">ƒêi·ªÅu ch·ªânh m√∫i gi·ªù hi·ªÉn th·ªã tr√™n chart (GMT+7 cho Vi·ªát Nam)</small>
                    </div>
                </div>

                <!-- PROFILE USAGE -->
                <div class="form-section">
                    <h6 class="section-title">üîå PROFILE USAGE</h6>
                    <p class="section-description">Ch·ªçn m·ª•c ƒë√≠ch s·ª≠ d·ª•ng profile n√†y trong Connection modal</p>

                    <div class="usage-options">
                        <label class="usage-option">
                            <input type="checkbox" id="edit-use-market-data">
                            <span>üìä Use for Market Data</span>
                            <p class="option-description">Profile n√†y s·∫Ω hi·ªán trong dropdown "Data Profile" ƒë·ªÉ load chart</p>
                        </label>

                        <label class="usage-option">
                            <input type="checkbox" id="edit-use-trading" checked>
                            <span>üíπ Use for Trading</span>
                            <p class="option-description">Profile n√†y s·∫Ω hi·ªán trong dropdown "Trading Profile" ƒë·ªÉ ƒë·∫∑t l·ªánh <span style="color: #f59e0b;">(C·∫ßn Trading Token cho DNSE)</span></p>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Exchange.testConnection()">
                    <i class="fas fa-plug"></i> Test Connection
                </button>
                <button class="btn btn-primary" onclick="Exchange.updateProfile()">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Add New Profile Button (Floating) -->
    <button id="addNewProfileBtn" class="floating-add-btn" onclick="Exchange.openAddNewModal()">
        <i class="fas fa-plus"></i> Add New
    </button>
{%endblock%}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/exchange.js') }}"></script>
    <script>
        // Show/hide cards based on selected exchange
        document.addEventListener('DOMContentLoaded', function() {
            const exchangeSelect = document.getElementById('exchange-select');
            const dnseCredentialsCard = document.getElementById('dnse-credentials-card');
            const marketDataCard = document.getElementById('market-data-settings-card');
            const dnseProtocol = document.getElementById('dnse-protocol');
            const dnseUsernameGroup = document.getElementById('dnse-username-group');
            const dnsePasswordGroup = document.getElementById('dnse-password-group');
            const dnseOtpGroup = document.getElementById('dnse-otp-group');
            const useForDataCheckbox = document.getElementById('use-for-data');
            
            function updateFormVisibility() {
                const selectedExchange = exchangeSelect.value;
                
                // Show/hide DNSE credentials card
                if (selectedExchange === 'DNSE' || selectedExchange === 'ENTRADE' || selectedExchange === 'ENTRADE-MQTT') {
                    dnseCredentialsCard.style.display = 'block';
                } else {
                    dnseCredentialsCard.style.display = 'none';
                }
                
                // Show market data card if "Use for Data" is checked
                if (useForDataCheckbox.checked) {
                    marketDataCard.style.display = 'block';
                } else {
                    marketDataCard.style.display = 'none';
                }
            }
            
            function updateDNSEFields() {
                const protocol = dnseProtocol.value;
                
                if (protocol === 'public') {
                    // Public API kh√¥ng c·∫ßn credentials
                    dnseUsernameGroup.style.display = 'none';
                    dnsePasswordGroup.style.display = 'none';
                    dnseOtpGroup.style.display = 'none';
                } else {
                    // REST API v√† MQTT c·∫ßn credentials
                    dnseUsernameGroup.style.display = 'block';
                    dnsePasswordGroup.style.display = 'block';
                    dnseOtpGroup.style.display = protocol === 'rest' ? 'block' : 'none';
                }
            }
            
            // Event listeners
            exchangeSelect.addEventListener('change', updateFormVisibility);
            useForDataCheckbox.addEventListener('change', updateFormVisibility);
            dnseProtocol.addEventListener('change', updateDNSEFields);
            
            // Initial state
            updateFormVisibility();
            updateDNSEFields();
        });
    </script>
{% endblock %}
