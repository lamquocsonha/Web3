{% extends "base.html" %}

{% block title %}Strategy Builder{% endblock %}

{% set active_page = 'strategy' %}

{% block content %}
<div style="display: flex; height: calc(100vh - 60px);">
        <!-- Chart Area 60% -->
        <div class="main-content-60" style="display: flex; flex-direction: column;">
            <!-- Chart Header - 2 Rows -->
            <div class="chart-header" style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem 1rem;">
                <!-- Row 1: Symbol + Badge + OHLCV + Position + Vol Checkbox + Status -->
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <span class="symbol-name" style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">VN30F1M</span>
                    <span class="symbol-timeframe" style="background: var(--primary); color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">1M</span>
                    
                    <!-- OHLCV Display Inline -->
                    <div class="ohlcv-display" style="display: flex; gap: 1rem; align-items: center;">
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">O:</span>
                            <span class="ohlcv-value" id="price-open" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">1892.00</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">H:</span>
                            <span class="ohlcv-value up" id="price-high" style="color: #10b981; font-weight: 500; font-size: 0.875rem;">1892.00</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">L:</span>
                            <span class="ohlcv-value down" id="price-low" style="color: #ef4444; font-weight: 500; font-size: 0.875rem;">1892.00</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">C:</span>
                            <span class="ohlcv-value" id="price-close" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">1892.00</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Vol:</span>
                            <span class="ohlcv-value" id="price-volume" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">5.781K</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Position:</span>
                            <span class="position-display position-flat" id="price-position" style="padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; background: #6b7280; color: white;">FLAT</span>
                        </div>
                    </div>
                    
                    
                    <!-- Connection Status - OFFLINE only for Strategy -->
                    <span class="connection-status status-offline" style="margin-left: auto; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; background: #ef4444; color: white;">OFFLINE</span>
                </div>
                
                <!-- Row 2: Date Time + Dropdown + Indicators + Signals -->
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <!-- Date and Time Display -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.25rem 0.75rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <span id="price-date" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">2025-01-02</span>
                        <span style="color: var(--text-secondary);">|</span>
                        <span id="price-time" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">09:35</span>
                    </div>
                    
                    <div class="chart-symbol-selector">
                        <select id="symbol-selector" class="form-control" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            <option value="VN30F1M">VN30F1M</option>
                            <option value="VN30F2M">VN30F2M</option>
                        </select>
                    </div>
                    
                    <div class="chart-tools" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary btn-indicators" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üìà Indicators</button>
                        <button class="btn btn-sm btn-primary btn-signals" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üîî Signals</button>
                    </div>
                </div>
            </div>
            
            <!-- Chart Main -->
            <div class="chart-main" style="flex: 1;">
                <div id="trading-chart"></div>
            </div>
            
            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="chart-zoom-buttons">
                    <!-- Volume Toggle -->
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <input type="checkbox" class="volume-toggle" checked style="cursor: pointer;">
                        <span>üìä Vol</span>
                    </label>
                    <button>‚óÄ</button>
                    <button>‚ñ∂</button>
                </div>
                
                <div class="chart-timeframe-selector">
                    <button class="timeframe-btn" data-timeframe="tick">Tick</button>
                    <button class="timeframe-btn active" data-timeframe="1m">1m</button>
                    <button class="timeframe-btn" data-timeframe="5m">5m</button>
                    <button class="timeframe-btn" data-timeframe="15m">15m</button>
                    <button class="timeframe-btn" data-timeframe="30m">30m</button>
                    <button class="timeframe-btn" data-timeframe="4h">4H</button>
                    <button class="timeframe-btn" data-timeframe="1d">1D</button>
                </div>
                
                <div class="chart-info">
                    <span id="chart-time">10:40:47 (UTC+7)</span>
                    
                    <!-- UTC Selector -->
                    <div class="utc-selector">
                        <label>UTC:</label>
                        <select id="utc-selector" class="form-control">
                            <option value="-12">-12</option>
                            <option value="-11">-11</option>
                            <option value="-10">-10</option>
                            <option value="-9">-9</option>
                            <option value="-8">-8</option>
                            <option value="-7">-7</option>
                            <option value="-6">-6</option>
                            <option value="-5">-5</option>
                            <option value="-4">-4</option>
                            <option value="-3">-3</option>
                            <option value="-2">-2</option>
                            <option value="-1">-1</option>
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                            <option value="3">+3</option>
                            <option value="4">+4</option>
                            <option value="5">+5</option>
                            <option value="6">+6</option>
                            <option value="7" selected>+7</option>
                            <option value="8">+8</option>
                            <option value="9">+9</option>
                            <option value="10">+10</option>
                            <option value="11">+11</option>
                            <option value="12">+12</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Strategy Editor 40% -->
        <div class="trading-panel trading-panel-40">
            <div class="trading-panel-header">
                <h2 class="trading-panel-title">STRATEGY BUILDER</h2>
            </div>
            
            <!-- Action Buttons Row -->
            <div style="display: flex; gap: 10px; padding: 0 1.5rem; margin-bottom: 1rem;">
                <button class="btn btn-sm btn-success" onclick="StrategyBuilder.newStrategy()">
                    ‚ûï New
                </button>
                <button class="btn btn-sm btn-primary" onclick="StrategyBuilder.saveStrategy()">
                    üíæ Save
                </button>
                <button class="btn btn-sm btn-warning" onclick="StrategyBuilder.openLoadModal()">
                    üìÇ Load
                </button>
            </div>
            
            <div class="order-form">
                <div class="form-group">
                    <label class="form-label">Strategy Information</label>
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px;">
                        <span style="font-size: 20px;">ü§ñ</span>
                        <span style="color: white; font-weight: 500;">Auto</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="text" id="strategy-name" class="form-control" placeholder="My Strategy" value="My Strategy">
                </div>
                
                <div class="form-group">
                    <textarea id="strategy-description" class="form-control" rows="3" placeholder="Description"></textarea>
                </div>
                
                <!-- Tabs -->
                <div class="strategy-tabs">
                    <button class="strategy-tab active" data-tab="entry">Entry</button>
                    <button class="strategy-tab" data-tab="exit">Exit</button>
                    <button class="strategy-tab" data-tab="indicator">Indicator</button>
                    <button class="strategy-tab" data-tab="engine">Trading Engine</button>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content active" id="entry-tab">
                    <div class="entry-buttons">
                        <button class="entry-btn active">
                            ‚òëÔ∏è Long Entry
                        </button>
                        <button class="entry-btn">
                            ‚õî Short Entry
                        </button>
                    </div>
                    
                    <div class="conditions-section">
                        <h6>Long Entry Conditions</h6>
                        <div class="no-conditions">No conditions added yet</div>
                        <button class="btn btn-primary btn-block">+ Add Long Condition</button>
                    </div>
                </div>
                
                <div class="tab-content" id="exit-tab">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">Exit conditions will be here</p>
                </div>
                
                <div class="tab-content" id="indicator-tab">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">Indicators will be here</p>
                </div>
                
                <div class="tab-content" id="engine-tab">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">Trading engine settings will be here</p>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h6>‚ö° Quick Actions</h6>
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn">üß™ Test</button>
                        <button class="quick-action-btn">üîÑ Refresh</button>
                        <button class="quick-action-btn">üóëÔ∏è Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load Strategy Modal -->
    <div id="loadStrategyModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h5>Select strategy to load:</h5>
                <button class="close-btn" onclick="StrategyBuilder.closeLoadModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div id="strategyList">
                    <!-- Strategies will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Success Notification -->
    <div id="saveNotification" class="save-notification">
        <div class="notification-content">
            <div class="notification-icon">‚úì</div>
            <div>
                <div class="notification-title">Strategy Saved Successfully!</div>
                <div class="notification-subtitle" id="savedStrategyName">My Strategy</div>
            </div>
        </div>
    </div>
{%endblock%}

{%block extra_js%}
    <script src="{{ url_for('static', filename='js/chart-indicators-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart-strategy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/strategy.js') }}"></script>
    <script>
        // Setup indicators and signals buttons
        document.addEventListener('DOMContentLoaded', function() {
            const indicatorsBtn = document.querySelector('.btn-indicators');
            const signalsBtn = document.querySelector('.btn-signals');
            
            if (indicatorsBtn) {
                indicatorsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openIndicatorsModal();
                    }
                });
            }
            
            if (signalsBtn) {
                signalsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openSignalsModal();
                    }
                });
            }
        });
    </script>
{% endblock %}
