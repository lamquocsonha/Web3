{% extends "base.html" %}

{% block title %}Bot Trading{% endblock %}

{% set active_page = 'bot' %}

{% block content %}
    <div style="display: flex; height: calc(100vh - 60px);">
        <!-- Chart Area 60% -->
        <div class="main-content-60" style="display: flex; flex-direction: column;">
            <!-- Chart Header - 2 Rows -->
            <div class="chart-header" style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem 1rem;">
                <!-- Row 1: Date Time | Dropdown | OHLCV | Position -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <!-- Date and Time Display -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.25rem 0.75rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <span id="price-date" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">2025-10-29</span>
                        <span style="color: var(--text-secondary);">|</span>
                        <span id="price-time" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">09:51</span>
                    </div>
                    
                    <div class="chart-symbol-selector">
                        <select id="symbol-selector" class="form-control" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            <option value="VN30F1M" selected>VN30F1M</option>
                            <option value="VN30F2M">VN30F2M</option>
                        </select>
                    </div>
                    
                    <!-- OHLCV Display Inline -->
                    <div class="ohlcv-display" style="display: flex; gap: 0.75rem; align-items: center;">
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">O:</span>
                            <span class="ohlcv-value" id="price-open" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 55px;">1943.50</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">H:</span>
                            <span class="ohlcv-value up" id="price-high" style="color: #10b981; font-weight: 600; font-size: 0.875rem; min-width: 55px;">1943.60</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">L:</span>
                            <span class="ohlcv-value down" id="price-low" style="color: #ef4444; font-weight: 600; font-size: 0.875rem; min-width: 55px;">1942.10</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">C:</span>
                            <span class="ohlcv-value" id="price-close" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 55px;">1942.30</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Vol:</span>
                            <span class="ohlcv-value" id="price-volume" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 45px;">892</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Position:</span>
                            <span class="position-display position-flat" id="price-position" style="padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; background: #6b7280; color: white;">FLAT</span>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: Online/Offline | Indicators | Signals -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    
                    <!-- Online/Offline Buttons -->
                    <div class="connection-toggle" style="display: flex; gap: 0.25rem; background: var(--bg-secondary); border-radius: 4px; padding: 0.25rem; border: 1px solid var(--border-color);">
                        <button id="btn-offline" class="btn btn-sm" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: transparent; color: var(--text-secondary); border: none;">üìÅ Offline</button>
                        <button id="btn-online" class="btn btn-sm btn-success" style="padding: 0.375rem 0.75rem; font-size: 0.875rem; background: #10b981; color: white; border: none;">üåê Online</button>
                    </div>
                    
                    <div class="chart-tools" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary btn-indicators" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üìà Indicators</button>
                        <button class="btn btn-sm btn-primary btn-signals" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üîî Signals</button>
                    </div>
                </div>
            </div>
            
            <!-- Chart Main -->
            <div class="chart-main">
                <div id="trading-chart"></div>
            </div>
            
            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="chart-zoom-buttons">
                    <!-- Volume Toggle -->
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <input type="checkbox" class="volume-toggle" checked style="cursor: pointer;">
                        <span>üìä Vol</span>
                    </label>
                    <button>‚óÄ</button>
                    <button>‚ñ∂</button>
                </div>
                
                <div class="chart-timeframe-selector">
                    <button class="timeframe-btn" data-timeframe="tick">Tick</button>
                    <button class="timeframe-btn active" data-timeframe="1m">1m</button>
                    <button class="timeframe-btn" data-timeframe="5m">5m</button>
                    <button class="timeframe-btn" data-timeframe="15m">15m</button>
                    <button class="timeframe-btn" data-timeframe="30m">30m</button>
                    <button class="timeframe-btn" data-timeframe="4h">4H</button>
                    <button class="timeframe-btn" data-timeframe="1d">1D</button>
                </div>
                
                <div class="chart-info">
                    <span id="chart-time">08:02:50 (UTC+7)</span>
                    
                    <!-- UTC Selector -->
                    <div class="utc-selector">
                        <label>UTC:</label>
                        <select id="utc-selector" class="form-control">
                            <option value="-12">-12</option>
                            <option value="-11">-11</option>
                            <option value="-10">-10</option>
                            <option value="-9">-9</option>
                            <option value="-8">-8</option>
                            <option value="-7">-7</option>
                            <option value="-6">-6</option>
                            <option value="-5">-5</option>
                            <option value="-4">-4</option>
                            <option value="-3">-3</option>
                            <option value="-2">-2</option>
                            <option value="-1">-1</option>
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                            <option value="3">+3</option>
                            <option value="4">+4</option>
                            <option value="5">+5</option>
                            <option value="6">+6</option>
                            <option value="7" selected>+7</option>
                            <option value="8">+8</option>
                            <option value="9">+9</option>
                            <option value="10">+10</option>
                            <option value="11">+11</option>
                            <option value="12">+12</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Chart Tabs -->
            <div class="chart-tabs">
                <button class="chart-tab active">‚óØ S·ªê L·ªÜNH</button>
                <button class="chart-tab">üìä VI TH·∫æ ‚óØ</button>
                <button class="chart-tab">üìù BOT LOGS</button>
            </div>
            
            <!-- Orders Table -->
            <div style="flex: 1; background-color: var(--bg-secondary); overflow-y: auto;">
                <table class="table orders-table">
                    <thead>
                        <tr>
                            <th>T√†i Kho·∫£n</th>
                            <th>Th·ªùi Gian</th>
                            <th>L·ªánh</th>
                            <th>M√£</th>
                            <th>Gi√° ƒê·∫∑t</th>
                            <th>Gi√° Kh·ªõp</th>
                            <th>Kh·ªëi L∆∞·ª£ng</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>H·ªßy</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">Kh√¥ng c√≥ l·ªánh n√†o</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Bot Trading Panel 40% -->
        <div class="trading-panel trading-panel-40" style="overflow-y: auto; padding: 1rem;">
            <h2 style="color: #3b82f6; margin: 0 0 1rem 0; font-size: 1.25rem;">BOT TRADING</h2>

            <div class="bot-status" style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;" id="botStatusDot"></span>
                    <span style="color: var(--text-primary);" id="botStatusText">ƒê√£ d·ª´ng</span>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" style="flex: 1;" id="startBotBtn" onclick="startBot()">‚ñ∂Ô∏è Start Bot</button>
                <button class="btn btn-danger" style="flex: 1; display: none;" id="stopBotBtn" onclick="stopBot()">‚èπÔ∏è Stop Bot</button>
            </div>

            <h3 style="font-size: 0.875rem; margin: 1rem 0 0.5rem 0; color: var(--text-secondary);">Ch·ªçn chi·∫øn l∆∞·ª£c:</h3>
            <select class="form-control" style="margin-bottom: 1rem;" id="botStrategySelect">
                <option value="">-- Ch·ªçn strategy --</option>
            </select>

            <h3 style="font-size: 0.875rem; margin: 1rem 0 0.5rem 0; color: var(--text-secondary);">T√†i kho·∫£n c·ªßa t√¥i:</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;" id="botYourAccountBtn" onclick="toggleAccountDropdown('botYour')">
                    <span>Ch·ªçn t√†i kho·∫£n</span>
                    <span id="botYourCount">0</span>
                </button>
                <div id="botYourDropdown" style="display: none; margin-top: 0.5rem;">
                    <div id="botYourAccountsList"></div>
                </div>
                <div id="botYourTags" style="margin-top: 0.5rem;"></div>
            </div>

            <h3 style="font-size: 0.875rem; margin: 1rem 0 0.5rem 0; color: var(--text-secondary);">T√†i kho·∫£n Client:</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;" id="botClientAccountBtn" onclick="toggleAccountDropdown('botClient')">
                    <span>Ch·ªçn t√†i kho·∫£n client</span>
                    <span id="botClientCount">0</span>
                </button>
                <div id="botClientDropdown" style="display: none; margin-top: 0.5rem;">
                    <div id="botClientAccountsList"></div>
                </div>
                <div id="botClientTags" style="margin-top: 0.5rem;"></div>
            </div>

            <h3 style="font-size: 0.875rem; margin: 1rem 0 0.5rem 0; color: var(--text-secondary);">M√£ giao d·ªãch:</h3>
            <input type="text" class="form-control" style="margin-bottom: 1rem;" id="botSymbol" value="VN30F1M" placeholder="Symbol">

            <h3 style="font-size: 0.875rem; margin: 1rem 0 0.5rem 0; color: var(--text-secondary);">Timeframe:</h3>
            <select class="form-control" style="margin-bottom: 1rem;" id="botTimeframe">
                <option value="1m">1 ph√∫t</option>
                <option value="5m" selected>5 ph√∫t</option>
                <option value="15m">15 ph√∫t</option>
                <option value="1h">1 gi·ªù</option>
                <option value="4h">4 gi·ªù</option>
                <option value="1d">1 ng√†y</option>
            </select>

            <div style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">C√†i ƒë·∫∑t Bot:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="botAutoRestart" checked>
                    <span style="font-size: 0.875rem;">T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i khi l·ªói</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="botTelegramAlert" checked>
                    <span style="font-size: 0.875rem;">Th√¥ng b√°o Telegram</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="botEmailAlert">
                    <span style="font-size: 0.875rem;">Th√¥ng b√°o Email</span>
                </label>
            </div>

            <div style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Th·ªëng k√™ Bot:</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Th·ªùi gian ch·∫°y:</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary);" id="botRuntime">--:--:--</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">T·ªïng l·ªánh:</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary);" id="botTotalTrades">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Win / Loss:</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary);" id="botWinLoss">0 / 0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">P&L h√¥m nay:</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary);" id="botPnl">0ƒë</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">L·ªánh ƒëang m·ªü:</span>
                    <span style="font-size: 0.875rem; color: var(--text-primary);" id="botOpenPositions">0</span>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/chart-indicators-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart-bot.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bot-trading.js') }}"></script>
    <script>
        // Setup indicators and signals buttons
        document.addEventListener('DOMContentLoaded', function() {
            const indicatorsBtn = document.querySelector('.btn-indicators');
            const signalsBtn = document.querySelector('.btn-signals');
            
            if (indicatorsBtn) {
                indicatorsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openIndicatorsModal();
                    }
                });
            }
            
            if (signalsBtn) {
                signalsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openSignalsModal();
                    }
                });
            }
            
            // Online/Offline Toggle with Data Source Switching
            const btnOnline = document.getElementById('btn-online');
            const btnOffline = document.getElementById('btn-offline');
            const connectionStatus = document.querySelector('.connection-status');
            let currentMode = localStorage.getItem('chart_mode_bot') || 'offline'; // Load saved mode
            
            if (btnOnline && btnOffline) {
                // Function to switch to Online mode
                function switchToOnline() {
                    // Check if we have an active connection
                    const savedConnection = localStorage.getItem('active_connection');
                    if (!savedConnection) {
                        alert('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt n·ªëi Exchange!\n\nVui l√≤ng:\n1. Click n√∫t "Connection" ·ªü g√≥c tr√™n\n2. Ch·ªçn Data Profile\n3. Ch·ªçn Symbol\n4. Click "Reload" ƒë·ªÉ k·∫øt n·ªëi');
                        return;
                    }
                    
                    currentMode = 'online';
                    localStorage.setItem('chart_mode_bot', 'online'); // Save mode
                    
                    // Update button styles
                    btnOnline.style.background = '#10b981';
                    btnOnline.style.color = 'white';
                    btnOffline.style.background = 'transparent';
                    btnOffline.style.color = 'var(--text-secondary)';
                    
                    // Update status badge
                    if (connectionStatus) {
                        connectionStatus.textContent = 'ONLINE';
                        connectionStatus.style.background = '#10b981';
                        connectionStatus.classList.remove('status-offline');
                        connectionStatus.classList.add('status-online');
                    }
                    
                    console.log('üì° Switched to ONLINE mode - Loading live data...');
                    
                    // Load online data
                    if (window.chartBot && typeof window.chartBot.loadOnlineData === 'function') {
                        const connection = JSON.parse(savedConnection);
                        window.chartBot.loadOnlineData(connection);
                    }
                    
                    // Emit event
                    window.dispatchEvent(new CustomEvent('chart-mode-changed', {
                        detail: { mode: 'online', chart: 'bot' }
                    }));
                }
                
                // Function to switch to Offline mode
                function switchToOffline() {
                    currentMode = 'offline';
                    localStorage.setItem('chart_mode_bot', 'offline'); // Save mode
                    
                    // Stop real-time updates
                    if (window.chartBot && typeof window.chartBot.stopRealtimeUpdates === 'function') {
                        window.chartBot.stopRealtimeUpdates();
                    }
                    
                    // Update button styles
                    btnOffline.style.background = '#10b981';
                    btnOffline.style.color = 'white';
                    btnOnline.style.background = 'transparent';
                    btnOnline.style.color = 'var(--text-secondary)';
                    
                    // Update status badge
                    if (connectionStatus) {
                        connectionStatus.textContent = 'OFFLINE';
                        connectionStatus.style.background = '#ef4444';
                        connectionStatus.classList.remove('status-online');
                        connectionStatus.classList.add('status-offline');
                    }
                    
                    console.log('üìÅ Switched to OFFLINE mode - Loading uploaded data...');
                    
                    // Load uploaded data
                    const uploadedData = window.UploadDataManager.getData();
                    if (uploadedData && uploadedData.csvData && uploadedData.csvData.length > 0) {
                        if (window.chartBot && typeof window.chartBot.loadUploadedData === 'function') {
                            window.UploadDataManager.loadToChart();
                        }
                    } else {
                        alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu Offline!\n\nVui l√≤ng upload file CSV tr∆∞·ªõc.');
                    }
                    
                    // Emit event
                    window.dispatchEvent(new CustomEvent('chart-mode-changed', {
                        detail: { mode: 'offline', chart: 'bot' }
                    }));
                }
                
                btnOnline.addEventListener('click', switchToOnline);
                btnOffline.addEventListener('click', switchToOffline);
                
                // Listen for connection events
                window.addEventListener('exchange-connected', (e) => {
                    console.log('üì° Exchange connected, switching to online mode');
                    switchToOnline();
                });
                
                window.addEventListener('exchange-disconnected', (e) => {
                    console.log('üîå Exchange disconnected, switching to offline mode');
                    switchToOffline();
                });
                
                // Restore saved mode on page load
                const savedConnection = localStorage.getItem('active_connection');
                const savedMode = localStorage.getItem('chart_mode_bot');
                
                console.log('üìä Restoring chart mode:', savedMode);
                console.log('üîó Has connection:', !!savedConnection);
                
                // Wait for UploadDataManager to load before switching modes
                function restoreMode() {
                    if (savedMode === 'online' && savedConnection) {
                        // Restore online mode
                        setTimeout(() => switchToOnline(), 800);
                    } else {
                        // Set to offline mode - wait longer for data to load
                        setTimeout(() => switchToOffline(), 1000);
                    }
                }
                
                // Listen for data loaded event
                window.addEventListener('uploadDataLoaded', () => {
                    console.log('üì• Upload data loaded, can now switch to offline');
                });
                
                // Start restore after a delay to let UploadDataManager initialize
                setTimeout(restoreMode, 300);
            }
        });
    </script>
{% endblock %}
