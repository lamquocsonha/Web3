{% extends "base.html" %}

{% block title %}Strategy Builder{% endblock %}

{% set active_page = 'strategy' %}

{% block content %}
    <div style="display: flex; height: calc(100vh - 60px);">
        <!-- Chart Area 60% -->
        <div class="main-content-60" style="display: flex; flex-direction: column;">
            <!-- Chart Header - 2 Rows -->
            <div class="chart-header" style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem 1rem;">
                <!-- Row 1: Date Time | Dropdown | OHLCV | Position -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <!-- Date and Time Display -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.25rem 0.75rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <span id="price-date" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">2025-10-29</span>
                        <span style="color: var(--text-secondary);">|</span>
                        <span id="price-time" style="color: var(--text-primary); font-weight: 500; font-size: 0.875rem;">09:51</span>
                    </div>
                    
                    <div class="chart-symbol-selector">
                        <select id="symbol-selector" class="form-control" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                            <option value="VN30F1M" selected>VN30F1M</option>
                            <option value="VN30F2M">VN30F2M</option>
                        </select>
                    </div>
                    
                    <!-- OHLCV Display Inline -->
                    <div class="ohlcv-display" style="display: flex; gap: 0.75rem; align-items: center;">
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">O:</span>
                            <span class="ohlcv-value" id="price-open" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 55px;">1943.50</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">H:</span>
                            <span class="ohlcv-value up" id="price-high" style="color: #10b981; font-weight: 600; font-size: 0.875rem; min-width: 55px;">1943.60</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">L:</span>
                            <span class="ohlcv-value down" id="price-low" style="color: #ef4444; font-weight: 600; font-size: 0.875rem; min-width: 55px;">1942.10</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">C:</span>
                            <span class="ohlcv-value" id="price-close" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 55px;">1942.30</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Vol:</span>
                            <span class="ohlcv-value" id="price-volume" style="color: var(--text-primary); font-weight: 600; font-size: 0.875rem; min-width: 45px;">892</span>
                        </div>
                        <div class="ohlcv-item" style="display: flex; gap: 0.25rem;">
                            <span class="ohlcv-label" style="color: var(--text-secondary); font-size: 0.875rem;">Position:</span>
                            <span class="position-display position-flat" id="price-position" style="padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; background: #6b7280; color: white;">FLAT</span>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: Indicators | Signals -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="chart-tools" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary btn-indicators" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üìà Indicators</button>
                        <button class="btn btn-sm btn-primary btn-signals" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">üîî Signals</button>
                    </div>
                </div>
            </div>
            
            <!-- Chart Main -->
            <div class="chart-main">
                <div id="trading-chart"></div>
            </div>
            
            <!-- Chart Controls -->
            <div class="chart-controls">
                <div class="chart-zoom-buttons">
                    <!-- Volume Toggle -->
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                        <input type="checkbox" class="volume-toggle" checked style="cursor: pointer;">
                        <span>üìä Vol</span>
                    </label>
                    <button>‚óÄ</button>
                    <button>‚ñ∂</button>
                </div>
                
                <div class="chart-timeframe-selector">
                    <button class="timeframe-btn" data-timeframe="tick">Tick</button>
                    <button class="timeframe-btn active" data-timeframe="1m">1m</button>
                    <button class="timeframe-btn" data-timeframe="5m">5m</button>
                    <button class="timeframe-btn" data-timeframe="15m">15m</button>
                    <button class="timeframe-btn" data-timeframe="30m">30m</button>
                    <button class="timeframe-btn" data-timeframe="4h">4H</button>
                    <button class="timeframe-btn" data-timeframe="1d">1D</button>
                </div>
                
                <div class="chart-info">
                    <span id="chart-time">08:02:50 (UTC+7)</span>
                    
                    <!-- UTC Selector -->
                    <div class="utc-selector">
                        <label>UTC:</label>
                        <select id="utc-selector" class="form-control">
                            <option value="-12">-12</option>
                            <option value="-11">-11</option>
                            <option value="-10">-10</option>
                            <option value="-9">-9</option>
                            <option value="-8">-8</option>
                            <option value="-7">-7</option>
                            <option value="-6">-6</option>
                            <option value="-5">-5</option>
                            <option value="-4">-4</option>
                            <option value="-3">-3</option>
                            <option value="-2">-2</option>
                            <option value="-1">-1</option>
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                            <option value="3">+3</option>
                            <option value="4">+4</option>
                            <option value="5">+5</option>
                            <option value="6">+6</option>
                            <option value="7" selected>+7</option>
                            <option value="8">+8</option>
                            <option value="9">+9</option>
                            <option value="10">+10</option>
                            <option value="11">+11</option>
                            <option value="12">+12</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Chart Tabs -->
            <div class="chart-tabs">
                <button class="chart-tab active">‚óØ S·ªê L·ªÜNH</button>
                <button class="chart-tab">üìä VI TH·∫æ ‚óØ</button>
                <button class="chart-tab">üìù BOT LOGS</button>
            </div>
            
            <!-- Orders Table -->
            <div style="flex: 1; background-color: var(--bg-secondary); overflow-y: auto;">
                <table class="table orders-table">
                    <thead>
                        <tr>
                            <th>T√†i Kho·∫£n</th>
                            <th>Th·ªùi Gian</th>
                            <th>L·ªánh</th>
                            <th>M√£</th>
                            <th>Gi√° ƒê·∫∑t</th>
                            <th>Gi√° Kh·ªõp</th>
                            <th>Kh·ªëi L∆∞·ª£ng</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>H·ªßy</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">Kh√¥ng c√≥ l·ªánh n√†o</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Trading Engine Panel 40% -->
        <div class="trading-panel trading-panel-40" style="overflow-y: auto; padding: 1rem;">
            <h2 style="color: #3b82f6; margin: 0 0 1rem 0; font-size: 1.25rem;">TRADING ENGINE</h2>

            <!-- Engine Control -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Engine Control:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="engineActive" checked>
                    <span style="font-size: 0.875rem;">‚úÖ Engine Active (Master Switch)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="buyActive" checked>
                    <span style="font-size: 0.875rem;">üìà Buy Active (Allow Long Positions)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="shortActive" checked>
                    <span style="font-size: 0.875rem;">üìâ Short Active (Allow Short Positions)</span>
                </label>
            </div>

            <!-- Trading Hours -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Trading Hours:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="tradingHoursActive" checked>
                    <span style="font-size: 0.875rem;">‚è∞ Enable Trading Hours Filter</span>
                </label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="font-size: 0.875rem; color: var(--text-secondary);">
                        Start Time:
                        <input type="time" class="form-control" style="margin-top: 0.25rem;" id="startTime" value="09:00">
                    </label>
                    <label style="font-size: 0.875rem; color: var(--text-secondary);">
                        End Time:
                        <input type="time" class="form-control" style="margin-top: 0.25rem;" id="endTime" value="14:30">
                    </label>
                    <label style="font-size: 0.875rem; color: var(--text-secondary);">
                        Base Time (for daily levels):
                        <input type="time" class="form-control" style="margin-top: 0.25rem;" id="baseTime" value="09:00">
                    </label>
                </div>
            </div>

            <!-- Order Limits -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Order Limits:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="orderLimitsActive" checked>
                    <span style="font-size: 0.875rem;">üî¢ Enable Order Limits</span>
                </label>
                <label style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
                    Buy Order Limit:
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="buyOrderLimit" value="10" min="1" max="100">
                </label>
                <label style="font-size: 0.875rem; color: var(--text-secondary); display: block;">
                    Short Order Limit:
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="shortOrderLimit" value="10" min="1" max="100">
                </label>
            </div>

            <!-- Position Sizing -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Position Sizing:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="positionSizingActive" checked>
                    <span style="font-size: 0.875rem;">üí∞ Enable Position Sizing</span>
                </label>
                <label style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
                    Position Size (% of capital):
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="positionSize" value="10" min="1" max="100">
                </label>
                <label style="font-size: 0.875rem; color: var(--text-secondary); display: block;">
                    Max Open Positions:
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="maxPositions" value="1" min="1" max="10">
                </label>
            </div>

            <!-- TP/SL Configuration -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">TP/SL Configuration:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="dynamicTpSlActive" checked>
                    <span style="font-size: 0.875rem;">üéØ Enable Dynamic TP/SL (AFL Style)</span>
                </label>
                <div style="font-size: 11px; color: #787b86; margin: 8px 0; line-height: 1.4;">
                    ‚ÑπÔ∏è Dynamic TP/SL adjusts based on profit levels (from AFL):<br>
                    ‚Ä¢ Profit ‚â•28: Trailing 55% of profit<br>
                    ‚Ä¢ Profit ‚â•20: Trailing 68% of profit<br>
                    ‚Ä¢ Profit ‚â•10: Trailing 12 points, SL 1 point<br>
                    ‚Ä¢ Profit ‚â•2: Trailing 13.9 points, SL 10.8 points<br>
                    ‚Ä¢ Default: Trailing 11.9 points, SL 10.3 points
                </div>
                <label style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
                    Initial Stop Loss (points):
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="initialSL" value="10.3" step="0.1">
                </label>
                <label style="font-size: 0.875rem; color: var(--text-secondary); display: block;">
                    Fee/Tax per trade (points):
                    <input type="number" class="form-control" style="margin-top: 0.25rem;" id="feeTax" value="1.0" step="0.1">
                </label>

                <!-- TP/SL Table for Long -->
                <div style="margin-top: 15px;">
                    <h4 style="color: #26a69a; font-size: 13px; margin-bottom: 8px;">üìà Long TP/SL Rules</h4>
                    <div id="tpslTableLong" style="font-size: 12px;"></div>
                </div>

                <!-- TP/SL Table for Short -->
                <div style="margin-top: 15px;">
                    <h4 style="color: #ef5350; font-size: 13px; margin-bottom: 8px;">üìâ Short TP/SL Rules</h4>
                    <div id="tpslTableShort" style="font-size: 12px;"></div>
                </div>
            </div>

            <!-- Entry/Exit Rules -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Entry/Exit Rules:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="noRepaintActive" checked>
                    <span style="font-size: 0.875rem;">üö´ No Repaint (Entry on next candle)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="exitInCandleActive" checked>
                    <span style="font-size: 0.875rem;">‚ö° Exit within current candle (H/L check)</span>
                </label>
                <div style="font-size: 11px; color: #787b86; margin: 8px 0; line-height: 1.4;">
                    ‚ÑπÔ∏è Entry: Signal at bar[i] ‚Üí Enter at bar[i+1] Open<br>
                    ‚ÑπÔ∏è Exit: Check SL/TP within bar[i] using High/Low
                </div>
            </div>

            <!-- Pivot Levels -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Pivot Levels:</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="pivotLevelsActive">
                    <span style="font-size: 0.875rem;">üìä Calculate Daily Pivot Levels</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="hhvLlvActive" checked>
                    <span style="font-size: 0.875rem;">üìà Track HHV/LLV since base time</span>
                </label>
            </div>

            <!-- Strategy Selection -->
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Strategy Selection:</h3>
                <label style="font-size: 0.875rem; color: var(--text-secondary); display: block;">
                    Choose Signal Strategy:
                    <select class="form-control" style="margin-top: 0.25rem;" id="signalStrategy">
                        <option value="">-- Ch·ªçn strategy --</option>
                        <option value="strategy_11">Chi·∫øn l∆∞·ª£c 11</option>
                        <option value="ema_cross">EMA Crossover</option>
                        <option value="rsi_divergence">RSI Divergence</option>
                        <option value="custom">Custom AFL Strategy</option>
                    </select>
                </label>
                <div style="font-size: 11px; color: #ef5350; margin: 8px 0;">
                    ‚ö†Ô∏è Strategy must be selected before starting bot
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="saveEngineConfig()">üíæ Save Config</button>
                <button class="btn btn-secondary" onclick="loadEngineConfig()">üìÇ Load Config</button>
                <button class="btn btn-secondary" onclick="testEngine()">üß™ Test Engine</button>
                <button class="btn btn-secondary" onclick="exportEngineConfig()">üì§ Export JSON</button>
            </div>

            <!-- Saved Configurations -->
            <div style="margin-top: 1rem;">
                <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Saved Configurations:</h3>
                <div id="engineConfigsList" style="padding: 1rem; background: var(--bg-secondary); border-radius: 4px; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                    Ch∆∞a c√≥ config n√†o
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/chart-indicators-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart-strategy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/strategy.js') }}"></script>
    <script>
        // Setup indicators and signals buttons
        document.addEventListener('DOMContentLoaded', function() {
            const indicatorsBtn = document.querySelector('.btn-indicators');
            const signalsBtn = document.querySelector('.btn-signals');
            
            if (indicatorsBtn) {
                indicatorsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openIndicatorsModal();
                    }
                });
            }
            
            if (signalsBtn) {
                signalsBtn.addEventListener('click', function() {
                    if (window.chartIndicatorsModal) {
                        window.chartIndicatorsModal.openSignalsModal();
                    }
                });
            }
        });
    </script>
{% endblock %}
