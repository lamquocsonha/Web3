<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trading Platform{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">AUTO OPTIMIZE TRADING SYSTEM</a>
        <ul class="navbar-nav">
            <li><a href="/manual-trading" class="nav-link {% if active_page == 'manual' %}active{% endif %}">Manual Trading</a></li>
            <li><a href="/bot-trading" class="nav-link {% if active_page == 'bot' %}active{% endif %}">Bot Trading</a></li>
            <li><a href="/strategy" class="nav-link {% if active_page == 'strategy' %}active{% endif %}">Strategy</a></li>
            <li><a href="/backtest" class="nav-link {% if active_page == 'backtest' %}active{% endif %}">Backtest</a></li>
            <li><a href="/optimize" class="nav-link {% if active_page == 'optimize' %}active{% endif %}">Optimize</a></li>
            <li><a href="/hft" class="nav-link {% if active_page == 'hft' %}active{% endif %}">HFT</a></li>
            <li><a href="/exchange" class="nav-link {% if active_page == 'exchange' %}active{% endif %}">Exchange</a></li>
            <li><a href="/clients" class="nav-link {% if active_page == 'clients' %}active{% endif %}">Clients</a></li>
        </ul>
        <div class="navbar-actions">
            <button id="upload-data-btn" class="btn btn-primary">üì§ Upload Data</button>
            <button id="connection-btn" class="btn btn-primary">üåê Connection</button>
            <button class="btn btn-secondary">‚öôÔ∏è</button>
            <button class="btn btn-danger">TEST</button>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- Upload Data Tooltip -->
    <div id="upload-tooltip" style="display: none; position: fixed; z-index: 1000; background: #1a1f2e; border: 1px solid #2d3748; border-radius: 8px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 300px;">
        <h3 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1rem;">üìÅ Th√¥ng tin d·ªØ li·ªáu:</h3>
        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Tr·∫°ng th√°i:</span>
                <span style="color: #10b981; display: flex; align-items: center; gap: 0.25rem;">
                    <input type="checkbox" id="data-status" checked disabled style="margin: 0;">
                    <span>ƒê√£ l∆∞u</span>
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">T√™n file:</span>
                <span style="color: var(--text-primary);" id="data-filename">VN30F1M_31 10 25_14 45 00 Python...</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Timeframe:</span>
                <span style="color: #3b82f6; font-weight: 600;" id="data-timeframe">1M</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">T·ª´ ng√†y:</span>
                <span style="color: var(--text-primary);" id="data-from">02 09:35/01/2025</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">ƒê·∫øn ng√†y:</span>
                <span style="color: var(--text-primary);" id="data-to">31 14:45/10/2025</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">S·ªë n·∫øn:</span>
                <span style="color: var(--text-primary);" id="data-bars">49,641</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Dung l∆∞·ª£ng:</span>
                <span style="color: var(--text-primary);" id="data-size">4.17 MB</span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button id="upload-btn" class="btn btn-primary" style="flex: 1; padding: 0.5rem;">üìÅ Upload</button>
            <button id="delete-data-btn" class="btn btn-danger" style="flex: 1; padding: 0.5rem;">üóëÔ∏è X√≥a</button>
        </div>
    </div>

    <!-- Connection Tooltip -->
    <div id="connection-tooltip" style="display: none; position: fixed; z-index: 1000; background: #1a1f2e; border: 1px solid #2d3748; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 350px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: #3b82f6; font-size: 1.1rem;">üåê K·∫øt n·ªëi Exchange:</h3>
            <button id="add-connection-btn" style="background: transparent; border: none; color: #10b981; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">+</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">Tr·∫°ng th√°i:</span>
            <span id="conn-status" style="color: #ef4444; font-weight: 600; font-size: 0.875rem;">Ch∆∞a k·∫øt n·ªëi</span>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.2); border-radius: 4px;">
                    <span style="font-size: 0.875rem;">üìä</span>
                </div>
                <label style="color: var(--text-secondary); font-size: 0.875rem; flex: 1;">Data Profile (Chart)</label>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <select id="data-profile-select" class="form-control" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                    <option value="">-- Select Data Profile --</option>
                </select>
                <button id="reload-data-profiles-btn" class="btn btn-secondary" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">üîÑ</button>
            </div>
            
            <div style="margin-top: 0.75rem;">
                <label style="display: block; color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">Symbol:</label>
                <select id="data-symbol-select" class="form-control" style="width: 100%; padding: 0.5rem; font-size: 0.875rem;">
                    <option value="">-- Ch·ªçn Symbol --</option>
                </select>
            </div>

            <div style="margin-top: 0.75rem;">
                <label style="display: block; color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">Timeframe:</label>
                <div id="data-timeframe-display" style="color: #3b82f6; font-weight: 600; font-size: 0.875rem;">--</div>
            </div>
        </div>

        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <button id="reload-connection-btn" class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">üîÑ Reload</button>
            <button id="disconnect-all-btn" class="btn btn-danger" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">üîå Disconnect All</button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1f2e; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; border: 1px solid #2d3748;">
            <h2 style="margin: 0 0 1.5rem 0; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem;">
                üìä C·∫•u h√¨nh d·ªØ li·ªáu
            </h2>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Timeframe c·ªßa d·ªØ li·ªáu:</label>
                <select id="timeframe-select" class="form-control" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                    <option value="1m" selected>1 ph√∫t (1m)</option>
                    <option value="5m">5 ph√∫t (5m)</option>
                    <option value="15m">15 ph√∫t (15m)</option>
                    <option value="30m">30 ph√∫t (30m)</option>
                    <option value="1h">1 gi·ªù (1h)</option>
                    <option value="4h">4 gi·ªù (4h)</option>
                    <option value="1d">1 ng√†y (1D)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">M√∫i gi·ªù c·ªßa file CSV:</label>
                <select id="csv-utc-select" class="form-control" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                    <option value="0">UTC +0 (London)</option>
                    <option value="1">UTC +1 (Paris)</option>
                    <option value="2">UTC +2 (Cairo)</option>
                    <option value="3">UTC +3 (Moscow)</option>
                    <option value="4">UTC +4 (Dubai)</option>
                    <option value="5">UTC +5 (Karachi)</option>
                    <option value="6">UTC +6 (Dhaka)</option>
                    <option value="7" selected>UTC +7 (Vietnam, Bangkok)</option>
                    <option value="8">UTC +8 (Singapore, HK)</option>
                    <option value="9">UTC +9 (Tokyo)</option>
                    <option value="10">UTC +10 (Sydney)</option>
                    <option value="-5">UTC -5 (New York)</option>
                    <option value="-6">UTC -6 (Chicago)</option>
                    <option value="-7">UTC -7 (Denver)</option>
                    <option value="-8">UTC -8 (Los Angeles)</option>
                </select>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; font-size: 0.75rem; color: var(--text-secondary);">
                    üí° Ch·ªçn m√∫i gi·ªù c·ªßa d·ªØ li·ªáu trong file CSV. Chart s·∫Ω t·ª± ƒë·ªông convert v·ªÅ m√∫i gi·ªù hi·ªán t·∫°i.
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button id="modal-cancel-btn" class="btn btn-secondary" style="flex: 1; padding: 0.75rem;">H·ªßy</button>
                <button id="modal-confirm-btn" class="btn btn-primary" style="flex: 1; padding: 0.75rem;">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Common Scripts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/connection-manager.js') }}"></script>
    
    <!-- Upload Data Handler -->
    <script>
    // Global upload data manager
    window.UploadDataManager = {
        currentFile: null,
        csvData: null,
        fileInfo: null,
        
        init() {
            this.setupUploadButton();
            this.loadStoredData();
        },
        
        setupUploadButton() {
            const uploadBtn = document.getElementById('upload-data-btn');
            const tooltip = document.getElementById('upload-tooltip');
            const uploadModal = document.getElementById('upload-modal');
            const uploadBtnInTooltip = document.getElementById('upload-btn');
            const deleteBtn = document.getElementById('delete-data-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            // Toggle tooltip
            uploadBtn.addEventListener('click', (e) => {
                e.stopPropagation();

                // Update tooltip with latest data before showing
                if (this.fileInfo) {
                    this.updateTooltip();
                } else {
                    // No data - show default state
                    document.getElementById('data-status').checked = false;
                    document.getElementById('data-filename').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                    document.getElementById('data-timeframe').textContent = '-';
                    document.getElementById('data-from').textContent = '-';
                    document.getElementById('data-to').textContent = '-';
                    document.getElementById('data-bars').textContent = '0';
                    document.getElementById('data-size').textContent = '0 MB';
                }

                const rect = uploadBtn.getBoundingClientRect();
                tooltip.style.display = tooltip.style.display === 'none' ? 'block' : 'none';
                tooltip.style.top = rect.bottom + 10 + 'px';
                tooltip.style.right = (window.innerWidth - rect.right) + 'px';
            });
            
            // Close tooltip when clicking outside
            document.addEventListener('click', (e) => {
                if (!tooltip.contains(e.target) && e.target !== uploadBtn) {
                    tooltip.style.display = 'none';
                }
            });
            
            // Upload button in tooltip
            uploadBtnInTooltip.addEventListener('click', () => {
                tooltip.style.display = 'none';
                this.openFileDialog();
            });
            
            // Delete button
            deleteBtn.addEventListener('click', async () => {
                if (confirm('X√≥a d·ªØ li·ªáu ƒë√£ upload?')) {
                    // Close tooltip first
                    tooltip.style.display = 'none';

                    // Show deleting message
                    console.log('üóëÔ∏è Deleting uploaded data...');

                    // Clear data (async)
                    await this.clearData();

                    console.log('‚úÖ Data deleted successfully');
                    alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu th√†nh c√¥ng!');
                }
            });
            
            // Modal buttons
            modalCancelBtn.addEventListener('click', () => {
                uploadModal.style.display = 'none';
                this.currentFile = null;
            });
            
            modalConfirmBtn.addEventListener('click', () => {
                const timeframe = document.getElementById('timeframe-select').value;
                const csvUtc = parseInt(document.getElementById('csv-utc-select').value);
                this.processFile(timeframe, csvUtc);
                uploadModal.style.display = 'none';
            });
        },
        
        openFileDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                this.currentFile = e.target.files[0];
                if (this.currentFile) {
                    // Check file size (max 200MB)
                    const maxSize = 200 * 1024 * 1024; // 200MB in bytes
                    if (this.currentFile.size > maxSize) {
                        alert(`‚ùå File qu√° l·ªõn!\n\nK√≠ch th∆∞·ªõc: ${(this.currentFile.size / (1024 * 1024)).toFixed(2)} MB\nGi·ªõi h·∫°n: 200 MB\n\nVui l√≤ng ch·ªçn file nh·ªè h∆°n.`);
                        this.currentFile = null;
                        return;
                    }

                    // Show modal to select timeframe
                    document.getElementById('upload-modal').style.display = 'flex';
                }
            };
            input.click();
        },
        
        async processFile(timeframe, csvUtc) {
            if (!this.currentFile) return;

            console.log('üì§ Uploading file to server...');
            console.log('Timeframe:', timeframe, 'UTC:', csvUtc);

            // Show uploading message
            const uploadingMsg = alert('‚è≥ ƒêang upload file l√™n server...');

            try {
                // Create FormData to send file
                const formData = new FormData();
                formData.append('file', this.currentFile);
                formData.append('timeframe', timeframe);
                formData.append('csv_utc', csvUtc);

                // Upload to server
                const response = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status !== 'success') {
                    throw new Error(result.message || 'Upload failed');
                }

                console.log('‚úÖ File uploaded to server:', result.filename);

                // Parse CSV to get first and last bar info
                const text = await this.currentFile.text();
                const csvData = this.parseCSV(text);

                if (csvData.length === 0) {
                    alert('File CSV kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng');
                    return;
                }

                const firstBar = csvData[0];
                const lastBar = csvData[csvData.length - 1];

                // Store ONLY filename and metadata in localStorage (very small)
                this.fileInfo = {
                    serverFilename: result.filename,  // Filename on server
                    originalFilename: this.currentFile.name,
                    timeframe: timeframe,
                    csvUtc: csvUtc,
                    fromDate: `${firstBar.date} ${firstBar.time}`,
                    toDate: `${lastBar.date} ${lastBar.time}`,
                    bars: csvData.length.toLocaleString(),
                    size: `${result.file_size_mb} MB`,
                    ticker: firstBar.ticker,
                    uploadedAt: new Date().toISOString()
                };

                // Save filename to localStorage (only ~1KB, not full CSV data!)
                localStorage.setItem('uploadedFileInfo', JSON.stringify(this.fileInfo));

                // Store CSV data in memory for current session
                this.csvData = csvData;

                console.log('üíæ File info saved to localStorage:', this.fileInfo);

                // Update tooltip
                this.updateTooltip();

                // Load data to chart
                this.loadToChart();

                // Show success message
                alert(`‚úÖ Upload th√†nh c√¥ng!\n\n` +
                      `File: ${this.currentFile.name}\n` +
                      `Timeframe: ${timeframe}\n` +
                      `S·ªë n·∫øn: ${this.fileInfo.bars}\n` +
                      `K√≠ch th∆∞·ªõc: ${result.file_size_mb} MB\n\n` +
                      `üíæ File ƒë√£ l∆∞u tr√™n server\n` +
                      `‚úÖ T·ªìn t·∫°i vƒ©nh vi·ªÖn khi chuy·ªÉn trang`);

            } catch (error) {
                console.error('‚ùå Upload failed:', error);
                alert(`‚ùå L·ªói upload file!\n\n${error.message}\n\nVui l√≤ng th·ª≠ l·∫°i.`);
                this.currentFile = null;
            }
        },
        
        parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            const data = [];
            
            console.log('Parsing CSV with', lines.length, 'lines');
            
            // Skip header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Remove any \r characters
                const cleanLine = line.replace(/\r/g, '');
                const parts = cleanLine.split(',');
                
                if (parts.length < 8) continue;
                
                // Parse: Ticker,Date,Time,Open,High,Low,Close,Volume
                const bar = {
                    ticker: parts[0].trim(),
                    date: parts[1].trim(),
                    time: parts[2].trim(),
                    open: parseFloat(parts[3]),
                    high: parseFloat(parts[4]),
                    low: parseFloat(parts[5]),
                    close: parseFloat(parts[6]),
                    volume: parseInt(parts[7])
                };
                
                // Validate
                if (!isNaN(bar.open) && !isNaN(bar.close)) {
                    data.push(bar);
                }
            }
            
            console.log('Parsed', data.length, 'valid bars');
            if (data.length > 0) {
                console.log('First bar:', data[0]);
                console.log('Last bar:', data[data.length - 1]);
            }
            
            return data;
        },
        
        updateTooltip() {
            if (!this.fileInfo) return;

            document.getElementById('data-status').checked = true;
            const displayFilename = this.fileInfo.originalFilename || this.fileInfo.filename || 'Unknown';
            document.getElementById('data-filename').textContent = displayFilename.substring(0, 30) + '...';
            document.getElementById('data-timeframe').textContent = this.fileInfo.timeframe.toUpperCase();
            document.getElementById('data-from').textContent = this.fileInfo.fromDate;
            document.getElementById('data-to').textContent = this.fileInfo.toDate;
            document.getElementById('data-bars').textContent = this.fileInfo.bars;
            document.getElementById('data-size').textContent = this.fileInfo.size;
        },
        
        async loadStoredData() {
            try {
                // Load file info from localStorage (only metadata, not full CSV)
                const storedInfo = localStorage.getItem('uploadedFileInfo');

                if (!storedInfo) {
                    console.log('‚ÑπÔ∏è No uploaded file info found');
                    return;
                }

                this.fileInfo = JSON.parse(storedInfo);
                console.log('üì¶ Found uploaded file info:', this.fileInfo);

                // Update tooltip
                this.updateTooltip();

                // Load CSV data from server
                if (this.fileInfo.serverFilename) {
                    console.log('üì• Loading CSV data from server:', this.fileInfo.serverFilename);

                    try {
                        const response = await fetch(`/api/get-csv/${this.fileInfo.serverFilename}`);

                        if (!response.ok) {
                            throw new Error(`Failed to load file: ${response.statusText}`);
                        }

                        const text = await response.text();
                        this.csvData = this.parseCSV(text);

                        console.log('‚úÖ Loaded from server:', this.csvData.length, 'bars');
                    } catch (error) {
                        console.error('‚ùå Failed to load CSV from server:', error);
                        alert(`‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i file t·ª´ server\n\nFile: ${this.fileInfo.originalFilename}\n\nVui l√≤ng upload l·∫°i.`);
                        this.clearData();
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load stored data:', error);
                this.clearData();
            }
        },
        
        async clearData() {
            console.log('üßπ Clearing all data...');

            // STEP 1: Reset tooltip IMMEDIATELY (synchronous)
            try {
                document.getElementById('data-status').checked = false;
                document.getElementById('data-filename').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                document.getElementById('data-timeframe').textContent = '-';
                document.getElementById('data-from').textContent = '-';
                document.getElementById('data-to').textContent = '-';
                document.getElementById('data-bars').textContent = '0';
                document.getElementById('data-size').textContent = '0 MB';
                console.log('‚úÖ Tooltip reset');
            } catch (error) {
                console.error('‚ö†Ô∏è Failed to reset tooltip:', error);
            }

            // STEP 2: Clear charts IMMEDIATELY (synchronous)
            try {
                if (window.chartManual) window.chartManual.clearChart();
                if (window.chartBot) window.chartBot.clearChart();
                if (window.chartStrategy) window.chartStrategy.clearChart();
                console.log('‚úÖ Charts cleared');
            } catch (error) {
                console.error('‚ö†Ô∏è Failed to clear charts:', error);
            }

            // STEP 3: Clear localStorage IMMEDIATELY (synchronous)
            try {
                localStorage.removeItem('uploadedFileInfo');
                console.log('‚úÖ localStorage cleared');
            } catch (error) {
                console.error('‚ö†Ô∏è Failed to clear localStorage:', error);
            }

            // STEP 4: Clear memory IMMEDIATELY (synchronous)
            const serverFilename = this.fileInfo?.serverFilename;
            this.csvData = null;
            this.fileInfo = null;
            this.currentFile = null;
            console.log('‚úÖ Memory cleared');

            // STEP 5: Delete file from server (async - happens in background)
            if (serverFilename) {
                try {
                    console.log('üóëÔ∏è Deleting file from server:', serverFilename);
                    const response = await fetch(`/api/delete-csv/${serverFilename}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        console.log('‚úÖ File deleted from server');
                    } else {
                        console.warn('‚ö†Ô∏è Failed to delete file from server:', result.message);
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Failed to delete file from server:', error);
                    // Don't throw - local data already cleared
                }
            }

            console.log('üéâ All data cleared successfully');
        },
        
        loadToChart() {
            console.log('üîµ loadToChart() called');
            
            if (!this.csvData || this.csvData.length === 0) {
                console.warn('‚ö†Ô∏è No CSV data to load');
                return;
            }
            
            try {
                console.log('üìä Loading', this.csvData.length, 'bars to chart');
                console.log('First CSV bar:', this.csvData[0]);
                console.log('Last CSV bar:', this.csvData[this.csvData.length - 1]);
                
                // Convert CSV data to chart format
                const chartData = [];
                const volumeData = [];
                
                for (let i = 0; i < this.csvData.length; i++) {
                    const bar = this.csvData[i];
                    
                    // Get CSV UTC offset from fileInfo (default to +7 if not set)
                    const csvUtcOffset = this.fileInfo && this.fileInfo.csvUtc !== undefined ? this.fileInfo.csvUtc : 7;
                    
                    // Parse date components
                    const dateParts = bar.date.split('-'); // YYYY-MM-DD
                    const timeParts = bar.time.split(':'); // HH:MM:SS
                    
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // JS months are 0-indexed
                    const day = parseInt(dateParts[2]);
                    const hour = parseInt(timeParts[0]);
                    const minute = parseInt(timeParts[1]);
                    const second = parseInt(timeParts[2] || 0);
                    
                    // Create UTC timestamp
                    // CSV time is in csvUtcOffset timezone
                    // Convert to UTC by subtracting the offset
                    const csvTimestamp = Date.UTC(year, month, day, hour, minute, second);
                    const utcTimestamp = csvTimestamp - (csvUtcOffset * 3600 * 1000);
                    const timestamp = Math.floor(utcTimestamp / 1000);
                    
                    // Debug first and every 10000th bar
                    if (i === 0 || i === 10000 || i === 20000 || i === 30000 || i === 40000) {
                        console.log(`Bar ${i} conversion:`, {
                            csvDate: bar.date,
                            csvTime: bar.time,
                            timestamp: timestamp,
                            utcDate: new Date(utcTimestamp).toISOString()
                        });
                    }
                    
                    chartData.push({
                        time: timestamp,
                        open: bar.open,
                        high: bar.high,
                        low: bar.low,
                        close: bar.close,
                        date: bar.date,
                        timeStr: bar.time
                    });
                    
                    volumeData.push({
                        time: timestamp,
                        value: bar.volume,
                        color: bar.close >= bar.open ? '#10b98180' : '#ef444480'
                    });
                }
            
            console.log('‚úÖ Converted to', chartData.length, 'chart bars');
            console.log('First chart bar:', chartData[0]);
            console.log('Last chart bar:', chartData[chartData.length - 1]);
            console.log('Time range:', new Date(chartData[0].time * 1000), 'to', new Date(chartData[chartData.length - 1].time * 1000));
            
            // Store metadata
            this.chartMetadata = {
                firstBar: this.csvData[0],
                lastBar: this.csvData[this.csvData.length - 1],
                totalBars: chartData.length
            };
            
            console.log('üì§ Calling chart.loadUploadedData()...');
            console.log('  chartData.length:', chartData.length);
            console.log('  volumeData.length:', volumeData.length);
            
            // Load to active chart
            if (window.chartManual && typeof window.chartManual.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartManual');
                window.chartManual.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartManual load completed');
            } else {
                console.warn('‚ö†Ô∏è chartManual not available');
            }
            
            if (window.chartBot && typeof window.chartBot.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartBot');
                window.chartBot.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartBot load completed');
            } else {
                console.warn('‚ö†Ô∏è chartBot not available');
            }
            
            if (window.chartStrategy && typeof window.chartStrategy.loadUploadedData === 'function') {
                console.log('‚Üí Loading to chartStrategy');
                window.chartStrategy.loadUploadedData(chartData, volumeData, this.chartMetadata);
                console.log('‚úÖ chartStrategy load completed');
            } else {
                console.warn('‚ö†Ô∏è chartStrategy not available');
            }
            
            console.log('üéâ loadToChart() completed successfully');
            
            } catch (error) {
                console.error('‚ùå Error in loadToChart():', error);
                console.error('Stack:', error.stack);
                alert('L·ªói khi load data l√™n chart: ' + error.message);
            }
        },
        
        getData() {
            return {
                csvData: this.csvData,
                fileInfo: this.fileInfo
            };
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        window.UploadDataManager.init();
    });
    </script>

    <!-- Connection Tooltip Handler -->
    <script>
    window.ConnectionTooltipManager = {
        isOpen: false,
        profiles: [],
        currentConnection: null, // Store current connection state
        
        init() {
            this.setupConnectionButton();
            this.loadProfiles();
            this.loadConnectionState(); // Load saved connection state
        },
        
        loadConnectionState() {
            // Load saved connection from localStorage
            const savedConnection = localStorage.getItem('active_connection');
            if (savedConnection) {
                try {
                    this.currentConnection = JSON.parse(savedConnection);
                    console.log('üì° Loaded saved connection:', this.currentConnection);
                    
                    // Update UI to show connected state
                    const statusEl = document.getElementById('conn-status');
                    if (statusEl && this.currentConnection) {
                        statusEl.textContent = 'ƒê√£ k·∫øt n·ªëi';
                        statusEl.style.color = '#10b981';
                        
                        // Update profile select
                        const dataProfileSelect = document.getElementById('data-profile-select');
                        if (dataProfileSelect && this.currentConnection.profileId) {
                            dataProfileSelect.value = this.currentConnection.profileId;
                            this.loadSymbolsForProfile(this.currentConnection.profileId);
                        }
                        
                        // Update symbol select
                        const dataSymbolSelect = document.getElementById('data-symbol-select');
                        if (dataSymbolSelect && this.currentConnection.symbol) {
                            setTimeout(() => {
                                dataSymbolSelect.value = this.currentConnection.symbol;
                            }, 100);
                        }
                        
                        // Notify all charts about the connection
                        this.notifyChartsAboutConnection();
                    }
                } catch (e) {
                    console.error('Failed to load connection state:', e);
                }
            }
        },
        
        saveConnectionState(profileId, symbol, profile) {
            this.currentConnection = {
                profileId: profileId,
                symbol: symbol,
                profile: profile,
                connectedAt: new Date().toISOString()
            };
            localStorage.setItem('active_connection', JSON.stringify(this.currentConnection));
            console.log('üíæ Saved connection state');
        },
        
        clearConnectionState() {
            this.currentConnection = null;
            localStorage.removeItem('active_connection');
            console.log('üóëÔ∏è Cleared connection state');
        },
        
        notifyChartsAboutConnection() {
            if (!this.currentConnection) return;
            
            // Dispatch event for charts to listen
            window.dispatchEvent(new CustomEvent('connection-restored', {
                detail: this.currentConnection
            }));
        },
        
        setupConnectionButton() {
            const connectionBtn = document.getElementById('connection-btn');
            const tooltip = document.getElementById('connection-tooltip');
            const addConnectionBtn = document.getElementById('add-connection-btn');
            const reloadDataProfilesBtn = document.getElementById('reload-data-profiles-btn');
            const reloadConnectionBtn = document.getElementById('reload-connection-btn');
            const disconnectAllBtn = document.getElementById('disconnect-all-btn');
            const dataProfileSelect = document.getElementById('data-profile-select');
            const dataSymbolSelect = document.getElementById('data-symbol-select');
            
            // Toggle tooltip
            connectionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const btnRect = connectionBtn.getBoundingClientRect();
                
                if (this.isOpen) {
                    tooltip.style.display = 'none';
                    this.isOpen = false;
                } else {
                    tooltip.style.display = 'block';
                    tooltip.style.top = (btnRect.bottom + 10) + 'px';
                    tooltip.style.right = (window.innerWidth - btnRect.right) + 'px';
                    this.isOpen = true;
                }
            });
            
            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (this.isOpen && !tooltip.contains(e.target) && e.target !== connectionBtn) {
                    tooltip.style.display = 'none';
                    this.isOpen = false;
                }
            });
            
            // Add connection button
            addConnectionBtn.addEventListener('click', () => {
                window.location.href = '/exchange';
            });
            
            // Reload data profiles
            reloadDataProfilesBtn.addEventListener('click', () => {
                this.loadProfiles();
            });
            
            // Reload connection
            reloadConnectionBtn.addEventListener('click', () => {
                const selectedProfile = dataProfileSelect.value;
                const selectedSymbol = dataSymbolSelect.value;
                
                if (!selectedProfile) {
                    alert('Vui l√≤ng ch·ªçn Data Profile');
                    return;
                }
                
                if (!selectedSymbol) {
                    alert('Vui l√≤ng ch·ªçn Symbol');
                    return;
                }
                
                this.connectToExchange(selectedProfile, selectedSymbol);
            });
            
            // Disconnect all
            disconnectAllBtn.addEventListener('click', () => {
                this.disconnectAll();
            });
            
            // Profile selection change
            dataProfileSelect.addEventListener('change', (e) => {
                const profileId = e.target.value;
                if (profileId) {
                    this.loadSymbolsForProfile(profileId);
                    this.updateTimeframeDisplay(profileId);
                } else {
                    dataSymbolSelect.innerHTML = '<option value="">-- Ch·ªçn Symbol --</option>';
                    document.getElementById('data-timeframe-display').textContent = '--';
                }
            });
        },
        
        async loadProfiles() {
            try {
                // Load from localStorage
                let allProfiles = JSON.parse(localStorage.getItem('exchange_profiles') || '[]');
                
                // Filter only Data profiles
                this.profiles = allProfiles.filter(p => p.use_for_data === true);
                
                console.log(`üìä Loaded ${this.profiles.length} data profiles`);
                this.updateProfileSelect();
            } catch (error) {
                console.error('Failed to load profiles:', error);
                this.profiles = [];
                this.updateProfileSelect();
            }
        },
        
        updateProfileSelect() {
            const select = document.getElementById('data-profile-select');
            select.innerHTML = '<option value="">-- Select Data Profile --</option>';
            
            this.profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name} (${profile.exchange})`;
                select.appendChild(option);
            });
        },
        
        async loadSymbolsForProfile(profileId) {
            const profile = this.profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            console.log('üìä Loading symbols for profile:', profile);
            
            const select = document.getElementById('data-symbol-select');
            select.innerHTML = '<option value="">-- Ch·ªçn Symbol --</option>';
            
            // Get symbols from profile tickers if available
            let symbols = [];
            if (profile.tickers && typeof profile.tickers === 'string') {
                // Parse tickers: "VN30F1M,VN30F2M,VCB,FPT"
                symbols = profile.tickers
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s && !s.startsWith('VD:'));
                
                console.log('‚úÖ Loaded symbols from profile tickers:', symbols);
            }
            
            // Fallback to default symbols if no tickers
            if (symbols.length === 0) {
                if (profile.exchange === 'DNSE' || profile.exchange === 'ENTRADE' || profile.exchange === 'ENTRADE-MQTT') {
                    symbols = ['VN30F1M', 'VN30F2M', 'VN30F3M'];
                } else if (profile.exchange === 'MT5') {
                    symbols = ['EURUSD', 'GBPUSD', 'USDJPY', 'GOLD'];
                } else if (profile.exchange === 'BINANCE') {
                    symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
                }
                console.log('‚ö†Ô∏è Using default symbols:', symbols);
            }
            
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${symbols.length} symbols for ${profile.name}`);
        },
        
        updateTimeframeDisplay(profileId) {
            const profile = this.profiles.find(p => p.id === profileId);
            const timeframeEl = document.getElementById('data-timeframe-display');
            
            if (!timeframeEl) {
                console.warn('‚ö†Ô∏è Timeframe display element not found');
                return;
            }
            
            if (profile && profile.timeframe) {
                // Convert timeframe format: "1m" -> "1M", "5m" -> "5M", "1h" -> "1H", "1d" -> "1D"
                const tf = profile.timeframe.toUpperCase();
                timeframeEl.textContent = tf;
                console.log('‚úÖ Timeframe display updated:', tf);
            } else {
                timeframeEl.textContent = '1M';
                console.log('‚ö†Ô∏è No timeframe in profile, using default 1M');
            }
        },
        
        async connectToExchange(profileId, symbol) {
            const profile = this.profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            try {
                // Show connecting status
                const statusEl = document.getElementById('conn-status');
                statusEl.textContent = 'ƒêang k·∫øt n·ªëi...';
                statusEl.style.color = '#f59e0b';
                
                // Simulate connection (in production, call real API)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Save connection state
                this.saveConnectionState(profileId, symbol, profile);
                
                // Update status
                statusEl.textContent = 'ƒê√£ k·∫øt n·ªëi';
                statusEl.style.color = '#10b981';
                
                console.log(`‚úÖ Connected to ${profile.exchange} - ${symbol}`);
                
                // Emit event for charts to switch to online mode
                window.dispatchEvent(new CustomEvent('exchange-connected', {
                    detail: {
                        exchange: profile.exchange,
                        profile: profile,
                        symbol: symbol,
                        profileId: profileId
                    }
                }));
                
                alert(`‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi ${profile.name} - ${symbol}`);
                
            } catch (error) {
                console.error('Connection failed:', error);
                const statusEl = document.getElementById('conn-status');
                statusEl.textContent = 'K·∫øt n·ªëi th·∫•t b·∫°i';
                statusEl.style.color = '#ef4444';
                alert('‚ùå K·∫øt n·ªëi th·∫•t b·∫°i!');
            }
        },
        
        disconnectAll() {
            const statusEl = document.getElementById('conn-status');
            statusEl.textContent = 'Ch∆∞a k·∫øt n·ªëi';
            statusEl.style.color = '#ef4444';
            
            // Clear connection state
            this.clearConnectionState();
            
            console.log('üîå Disconnected from all exchanges');
            
            // Emit event for charts to switch to offline mode
            window.dispatchEvent(new CustomEvent('exchange-disconnected'));
            
            alert('üîå ƒê√£ ng·∫Øt k·∫øt n·ªëi');
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        window.ConnectionTooltipManager.init();
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
