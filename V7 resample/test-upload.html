<!DOCTYPE html>
<html>
<head>
    <title>Test Upload Data</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1f2e; color: #fff; }
        #chart { width: 100%; height: 500px; margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #141824; padding: 10px; overflow-x: auto; }
        .log { margin: 5px 0; padding: 5px; background: #141824; }
    </style>
</head>
<body>
    <h1>Test Upload & Chart Logic</h1>
    <button onclick="testParseCSV()">1. Test Parse CSV</button>
    <button onclick="testConvertToChart()">2. Test Convert to Chart</button>
    <button onclick="testLoadChart()">3. Test Load Chart</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    <div id="chart"></div>
    
    <script>
        let csvData = null;
        let chartData = null;
        let volumeData = null;
        let chart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        
        function log(msg, data = null) {
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = msg;
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                div.appendChild(pre);
            }
            document.getElementById('logs').appendChild(div);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Sample CSV data (first 5 rows from actual file)
        const sampleCSV = `Ticker,Date,Time,Open,High,Low,Close,Volume
VN30F1M,2025-01-02,09:35:00,1348,1348.4,1348,1348.4,6863
VN30F1M,2025-01-02,09:36:00,1348.4,1348.5,1348.2,1348.2,855
VN30F1M,2025-01-02,09:37:00,1348.2,1348.5,1347.9,1348.4,947
VN30F1M,2025-01-02,09:38:00,1348.4,1348.5,1348.2,1348.5,1347`;
        
        function testParseCSV() {
            log('=== Testing CSV Parse ===');
            const lines = sampleCSV.split(/\r?\n/).filter(line => line.trim());
            const data = [];
            
            log('Total lines: ' + lines.length);
            
            // Skip header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                const parts = line.split(',');
                
                if (parts.length < 8) continue;
                
                const bar = {
                    ticker: parts[0].trim(),
                    date: parts[1].trim(),
                    time: parts[2].trim(),
                    open: parseFloat(parts[3]),
                    high: parseFloat(parts[4]),
                    low: parseFloat(parts[5]),
                    close: parseFloat(parts[6]),
                    volume: parseInt(parts[7])
                };
                
                data.push(bar);
            }
            
            csvData = data;
            log('✅ Parsed ' + data.length + ' bars');
            log('First bar:', data[0]);
            log('Last bar:', data[data.length - 1]);
        }
        
        function testConvertToChart() {
            if (!csvData) {
                log('❌ Run Parse CSV first!');
                return;
            }
            
            log('=== Testing Convert to Chart Format ===');
            const cData = [];
            const vData = [];
            
            for (let i = 0; i < csvData.length; i++) {
                const bar = csvData[i];
                
                // Parse date: YYYY-MM-DD HH:MM:SS
                const dateTimeStr = `${bar.date}T${bar.time}`;
                const dateTime = new Date(dateTimeStr);
                
                if (isNaN(dateTime.getTime())) {
                    log('❌ Invalid date: ' + dateTimeStr);
                    continue;
                }
                
                const timestamp = Math.floor(dateTime.getTime() / 1000);
                
                if (i === 0) {
                    log('First conversion:');
                    log('  Input: ' + bar.date + ' ' + bar.time);
                    log('  dateTimeStr: ' + dateTimeStr);
                    log('  Date object: ' + dateTime.toISOString());
                    log('  Timestamp: ' + timestamp);
                }
                
                cData.push({
                    time: timestamp,
                    open: bar.open,
                    high: bar.high,
                    low: bar.low,
                    close: bar.close
                });
                
                vData.push({
                    time: timestamp,
                    value: bar.volume,
                    color: bar.close >= bar.open ? '#10b98180' : '#ef444480'
                });
            }
            
            chartData = cData;
            volumeData = vData;
            
            log('✅ Converted ' + cData.length + ' bars');
            log('First chart bar:', cData[0]);
            log('Last chart bar:', cData[cData.length - 1]);
            log('Time range: ' + new Date(cData[0].time * 1000) + ' to ' + new Date(cData[cData.length - 1].time * 1000));
        }
        
        function testLoadChart() {
            if (!chartData) {
                log('❌ Run Convert first!');
                return;
            }
            
            log('=== Testing Load to Chart ===');
            
            const container = document.getElementById('chart');
            
            if (!chart) {
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 500,
                    layout: {
                        background: { color: '#141824' },
                        textColor: '#a0a0a0',
                    },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                    },
                    localization: {
                        timeFormatter: (time) => {
                            const date = new Date(time * 1000);
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            return `${hours}:${minutes}`;
                        }
                    }
                });
                
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderUpColor: '#10b981',
                    borderDownColor: '#ef4444',
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444',
                });
                
                volumeSeries = chart.addHistogramSeries({
                    color: '#3b82f6',
                    priceFormat: { type: 'volume' },
                    priceScaleId: 'left',
                    scaleMargins: { top: 0.8, bottom: 0 },
                });
            }
            
            log('Setting candlestick data...');
            candlestickSeries.setData(chartData);
            
            log('Setting volume data...');
            volumeSeries.setData(volumeData);
            
            log('Fitting content...');
            chart.timeScale().fitContent();
            
            log('✅ Chart loaded with ' + chartData.length + ' bars');
        }
    </script>
</body>
</html>
